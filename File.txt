import sqlite3
import re
import json
import asyncio
import requests
import os
from datetime import datetime, timedelta, timezone
from telegram import Update, ReplyKeyboardMarkup, ReplyKeyboardRemove, InlineKeyboardMarkup, InlineKeyboardButton
from telegram.ext import Application, CommandHandler, MessageHandler, filters, ContextTypes, ConversationHandler, CallbackQueryHandler

# -------------------- CONSTANTS AND SETTINGS --------------------
BOT_TOKEN = "7405848829:AAHxDv0DP_Co512vOvGw_PDsXYDjE4fgOJ0"
YEKATERINBURG_TZ = timezone(timedelta(hours=5))
DEFAULT_GROUP = "–ò–î-127"

# States for ConversationHandler
AWAITING_HOMEWORK, AWAITING_INFO, AWAITING_SPORT, AWAITING_SUGGESTION, AWAITING_HOMEWORK_DELETE, AWAITING_INFO_DELETE, AWAITING_GROUP, AWAITING_USER_DELETE, AWAITING_SUGGESTION_DELETE, AWAITING_SPORT_DELETE = range(10)

# User Roles
ROLE_STUDENT = 'student'
ROLE_PHYSICAL_ORGANIZER = 'physical_organizer'
ROLE_IT_SPECIALIST = 'it_specialist'

# Special Users (ID and username)
DEVELOPER_ID = 1775957387
SPECIAL_USERS = {
    5013216284: {'role': ROLE_IT_SPECIALIST, 'username': '@kimertuzz3', 'name': '–°—Ç–∞—Ä–æ—Å—Ç–∞'},
    DEVELOPER_ID: {'role': ROLE_IT_SPECIALIST, 'username': '@imya_polbzovatela', 'name': '–ó–∞–º –°—Ç–∞—Ä–æ—Å—Ç—ã'},
    5078637058: {'role': ROLE_PHYSICAL_ORGANIZER, 'username': '@NateDiazFight', 'name': '–§–∏–∑. –æ—Ä–≥.'}
}

# Full list of groups
ALL_GROUPS = [
    "–ò–î-126", "–ò–î-127", "–ú–î-1126", "–ú–î-1127", "–ú–î-1128", "–û–î–õ–î-107", "–û–î–õ–î-108",
    "–ü–°–î-144", "–ü–°–î-145", "–¢–î-1128", "–¢–î-1129", "–¢–î-1130", "–¢–ú–î-123", "–¢–ú–î-124", "–¢–ú–î-125",
    "–≠–î-1111", "–≠–î-1112", "–≠–î-1113", "–ò–î-224", "–ò–î-225", "–ú–î-2123", "–ú–î-2124", "–ú–î-2125",
    "–û–¥–õ–î-205", "–û–¥–õ–î-206", "–ü–°–î-242", "–ü–°–î-243", "–¢–î-2125", "–¢–î-2126", "–¢–î-2127", "–¢–ú–î-220",
    "–¢–ú–î-221", "–¢–ú–î-222", "–≠–î-2108", "–≠–î-2109", "–≠–î-2110", "–ò–î-323", "–ú–î-3121", "–ú–î-3122",
    "–û–°–ê–î-302", "–û–¥–õ–î-303", "–û–¥–õ–î-304", "–ü–°–î-340", "–ü–°–î-341", "–¢–î-3121", "–¢–î-3123", "–¢–ú–î-317",
    "–¢–ú–î-318", "–≠–î-3106", "–≠–î-3107", "–ò–î-421", "–ò–î-422"
]

# Schedule cache
schedule_cache = {}
last_schedule_check = None

# -------------------- DATABASE FUNCTIONS --------------------

def init_db():
    """Initializes the database"""
    conn = sqlite3.connect('bot_data.db')
    cur = conn.cursor()
    
    # Users table
    cur.execute('''CREATE TABLE IF NOT EXISTS users (
        user_id INTEGER PRIMARY KEY,
        username TEXT,
        first_name TEXT,
        last_name TEXT,
        group_name TEXT,
        role TEXT DEFAULT 'student',
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
    )''')
    
    # Homeworks table
    cur.execute('''CREATE TABLE IF NOT EXISTS homeworks (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        subject TEXT,
        task TEXT,
        deadline TEXT,
        group_name TEXT,
        added_by INTEGER,
        photo_id TEXT,
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        FOREIGN KEY (added_by) REFERENCES users (user_id)
    )''')
    
    # Notifications table (from IT specialists)
    cur.execute('''CREATE TABLE IF NOT EXISTS notifications (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        message TEXT,
        group_name TEXT,
        added_by INTEGER,
        photo_id TEXT,
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        FOREIGN KEY (added_by) REFERENCES users (user_id)
    )''')
    
    # Sport notifications table (from physical organizer)
    cur.execute('''CREATE TABLE IF NOT EXISTS sport_notifications (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        message TEXT,
        group_name TEXT,
        added_by INTEGER,
        photo_id TEXT,
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        FOREIGN KEY (added_by) REFERENCES users (user_id)
    )''')
    
    # Suggestions table
    cur.execute('''CREATE TABLE IF NOT EXISTS suggestions (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        user_id INTEGER,
        message TEXT,
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        FOREIGN KEY (user_id) REFERENCES users (user_id)
    )''')
    
    conn.commit()
    conn.close()
    print("–õ–û–ì: –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞.")

def get_db_connection():
    """Creates a connection to the database"""
    conn = sqlite3.connect('bot_data.db')
    conn.row_factory = sqlite3.Row
    return conn

def get_user(user_id):
    """Gets user information"""
    conn = get_db_connection()
    user = conn.execute('SELECT * FROM users WHERE user_id = ?', (user_id,)).fetchone()
    conn.close()
    return user

def get_all_users():
    """Gets a list of all users"""
    conn = get_db_connection()
    users = conn.execute('SELECT user_id, first_name, username, group_name FROM users').fetchall()
    conn.close()
    return users

def add_user(user_id, username, first_name, last_name):
    """Adds a new user to the database or updates existing user"""
    conn = get_db_connection()
    
    existing_user = conn.execute('SELECT * FROM users WHERE user_id = ?', (user_id,)).fetchone()
    
    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ä–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    role = ROLE_STUDENT
    if user_id in SPECIAL_USERS:
        role = SPECIAL_USERS[user_id]['role']
    
    if not existing_user:
        # –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        conn.execute('''INSERT INTO users (user_id, username, first_name, last_name, group_name, role)
                     VALUES (?, ?, ?, ?, ?, ?)''',
                     (user_id, username, first_name, last_name, DEFAULT_GROUP, role))
        print(f"–õ–û–ì: –î–æ–±–∞–≤–ª–µ–Ω –Ω–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {first_name} (ID: {user_id}) —Å –≥—Ä—É–ø–ø–æ–π {DEFAULT_GROUP} –∏ —Ä–æ–ª—å—é {role}")
    else:
        # –û–±–Ω–æ–≤–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–æ—Å–æ–±–µ–Ω–Ω–æ —Ä–æ–ª—å, –µ—Å–ª–∏ –∏–∑–º–µ–Ω–∏–ª–∞—Å—å)
        conn.execute('''UPDATE users 
                     SET username = ?, first_name = ?, last_name = ?, role = ?
                     WHERE user_id = ?''',
                     (username, first_name, last_name, role, user_id))
        print(f"–õ–û–ì: –û–±–Ω–æ–≤–ª–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {first_name} (ID: {user_id}), —Ä–æ–ª—å: {role}")
    
    conn.commit()
    conn.close()

def update_user_group(user_id, group_name):
    """Updates the user's group"""
    conn = get_db_connection()
    conn.execute('UPDATE users SET group_name = ? WHERE user_id = ?', (group_name, user_id))
    conn.commit()
    conn.close()
    print(f"–õ–û–ì: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} —Å–º–µ–Ω–∏–ª –≥—Ä—É–ø–ø—É –Ω–∞ {group_name}")
    
def get_total_user_count():
    """Gets the total number of users in the database"""
    conn = get_db_connection()
    count = conn.execute('SELECT COUNT(*) FROM users').fetchone()[0]
    conn.close()
    return count
    
# Deletion Functions
def delete_homework(hw_id):
    conn = get_db_connection()
    conn.execute('DELETE FROM homeworks WHERE id = ?', (hw_id,))
    conn.commit()
    conn.close()

def delete_notification(notif_id):
    conn = get_db_connection()
    conn.execute('DELETE FROM notifications WHERE id = ?', (notif_id,))
    conn.commit()
    conn.close()

def delete_sport_notification(notif_id):
    conn = get_db_connection()
    conn.execute('DELETE FROM sport_notifications WHERE id = ?', (notif_id,))
    conn.commit()
    conn.close()

def delete_user(user_id):
    conn = get_db_connection()
    conn.execute('DELETE FROM users WHERE user_id = ?', (user_id,))
    conn.commit()
    conn.close()
    print(f"–õ–û–ì: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} —É–¥–∞–ª–µ–Ω –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö.")

def delete_suggestion(suggestion_id):
    conn = get_db_connection()
    conn.execute('DELETE FROM suggestions WHERE id = ?', (suggestion_id,))
    conn.commit()
    conn.close()
    print(f"–õ–û–ì: –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ {suggestion_id} —É–¥–∞–ª–µ–Ω–æ –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö.")

def get_all_sport_notifications():
    """Gets all sport notifications"""
    conn = get_db_connection()
    notifications = conn.execute('''SELECT s.*, u.first_name 
                                 FROM sport_notifications s JOIN users u ON s.added_by = u.user_id 
                                 ORDER BY s.created_at DESC''').fetchall()
    conn.close()
    return notifications

# -------------------- SCHEDULE FUNCTIONS --------------------

def fetch_schedule_data():
    """Fetches schedule data from the website"""
    try:
        url = "https://pmk-online.ru/students/schedule/"
        headers = {'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'}
        resp = requests.get(url, headers=headers, timeout=10)
        resp.raise_for_status()
        html = resp.text

        match = re.search(r"const scheduleData\s*=\s*(\{.*?\});", html, re.S)
        if not match:
            print("–û–®–ò–ë–ö–ê: –ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ scheduleData –Ω–∞ —Å–∞–π—Ç–µ.")
            return None

        schedule_raw = match.group(1)
        schedule_json_str = schedule_raw.replace(";", "")
        return json.loads(schedule_json_str)
    
    except Exception as e:
        print(f"–û–®–ò–ë–ö–ê: –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ: {e}")
        return None

def filter_today_lessons(lessons):
    """Filters lessons for today considering Yekaterinburg time"""
    today_yekat = datetime.now(YEKATERINBURG_TZ).date()
    return [lesson for lesson in lessons if lesson.get('date') and datetime.fromisoformat(lesson['date'].replace('Z', '+00:00')).astimezone(YEKATERINBURG_TZ).date() == today_yekat]

def filter_tomorrow_lessons(lessons):
    """Filters lessons for tomorrow considering Yekaterinburg time"""
    tomorrow_yekat = (datetime.now(YEKATERINBURG_TZ) + timedelta(days=1)).date()
    return [lesson for lesson in lessons if lesson.get('date') and datetime.fromisoformat(lesson['date'].replace('Z', '+00:00')).astimezone(YEKATERINBURG_TZ).date() == tomorrow_yekat]

def filter_week_lessons(lessons):
    """Filters lessons for the week considering Yekaterinburg time"""
    today_yekat = datetime.now(YEKATERINBURG_TZ).date()
    week_end = today_yekat + timedelta(days=7)
    return [lesson for lesson in lessons if lesson.get('date') and today_yekat <= datetime.fromisoformat(lesson['date'].replace('Z', '+00:00')).astimezone(YEKATERINBURG_TZ).date() <= week_end]

def get_lesson_time(lesson_number):
    """Returns the time of a lesson by its number"""
    lesson_times = {
        1: ("08:30", "10:05"), 2: ("10:15", "11:50"), 3: ("12:40", "14:15"),
        4: ("14:25", "16:00"), 5: ("16:10", "17:45"), 6: ("17:55", "19:30"),
    }
    return lesson_times.get(lesson_number, ("‚ùì", "‚ùì"))

def format_schedule(lessons, title):
    if not lessons:
        return "‚úÖ –ù–µ—Ç –∑–∞–Ω—è—Ç–∏–π"
    
    lessons.sort(key=lambda x: (x.get('date', ''), x.get('lessonNumber', 0)))
    
    result = [f"<b>{title}</b>\n"]
    current_date = None
    for lesson in lessons:
        try:
            lesson_date_utc = datetime.fromisoformat(lesson['date'].replace('Z', '+00:00'))
            lesson_date_yekat = lesson_date_utc.astimezone(YEKATERINBURG_TZ)
            date_str = lesson_date_yekat.strftime('%d.%m.%Y')
            
            if date_str != current_date:
                current_date = date_str
                day_names = ['–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫', '–í—Ç–æ—Ä–Ω–∏–∫', '–°—Ä–µ–¥–∞', '–ß–µ—Ç–≤–µ—Ä–≥', '–ü—è—Ç–Ω–∏—Ü–∞', '–°—É–±–±–æ—Ç–∞', '–í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ']
                day_of_week = day_names[lesson_date_yekat.weekday()]
                result.append(f"\nüìÖ <b>{date_str} ({day_of_week})</b>")
            
            lesson_number = lesson.get('lessonNumber', 0)
            start_time, end_time = get_lesson_time(lesson_number)
            
            lesson_text = (
                f"    ‚è∞ {start_time}-{end_time} | {lesson_number} –ø–∞—Ä–∞\n"
                f"    üìö {lesson.get('subjectFull', 'N/A')}\n"
                f"    üë®‚Äçüè´ {lesson.get('teacher', 'N/A')}\n"
                f"    üö™ {lesson.get('room', 'N/A')}\n"
            )
            result.append(lesson_text)
        except Exception as e:
            print(f"–û–®–ò–ë–ö–ê: –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–∞—Ä—É: {e}")
            continue
    
    result.append(f"\nüìä <b>–í—Å–µ–≥–æ –∑–∞–Ω—è—Ç–∏–π:</b> {len(lessons)}")
    return "\n".join(result)

def get_schedule(period, group_name):
    """Gets and formats the schedule for the selected period and group"""
    try:
        global schedule_cache, last_schedule_check
        
        # Check if we need to refresh the cache (every hour)
        now = datetime.now(YEKATERINBURG_TZ)
        if last_schedule_check is None or (now - last_schedule_check).total_seconds() > 3600:
            schedule_data = fetch_schedule_data()
            if schedule_data:
                schedule_cache = schedule_data
                last_schedule_check = now
                print("–õ–û–ì: –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–æ –∏–∑ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞")
            else:
                print("–õ–û–ì: –ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ, –∏—Å–ø–æ–ª—å–∑—É–µ–º –∫—ç—à")
        else:
            schedule_data = schedule_cache
            print("–õ–û–ì: –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ")
        
        if not schedule_data:
            return "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ"

        if group_name not in schedule_data:
            return f"‚ùå –ù–µ—Ç —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è –¥–ª—è –≥—Ä—É–ø–ø—ã {group_name}"

        lessons = schedule_data[group_name]
        
        if period == 'üìÖ –°–µ–≥–æ–¥–Ω—è':
            filtered_lessons = filter_today_lessons(lessons)
            title = f"üìÖ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è ({group_name})"
        elif period == 'üìÖ –ó–∞–≤—Ç—Ä–∞':
            filtered_lessons = filter_tomorrow_lessons(lessons)
            title = f"üìÖ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –Ω–∞ –∑–∞–≤—Ç—Ä–∞ ({group_name})"
        elif period == 'üìÖ –ù–µ–¥–µ–ª—è':
            filtered_lessons = filter_week_lessons(lessons)
            title = f"üìÖ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –Ω–∞ –Ω–µ–¥–µ–ª—é ({group_name})"
        else:
            filtered_lessons = lessons
            title = f"üìÖ –í—Å–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ ({group_name})"

        if not filtered_lessons:
            return f"‚úÖ –ù–µ—Ç –∑–∞–Ω—è—Ç–∏–π –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –ø–µ—Ä–∏–æ–¥–∞."

        return format_schedule(filtered_lessons, title)

    except Exception as e:
        print(f"–û–®–ò–ë–ö–ê: –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è: {str(e)}")
        return f"‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞: {str(e)}"

async def check_schedule_changes(context: ContextTypes.DEFAULT_TYPE):
    """Checks for schedule changes and notifies users"""
    global schedule_cache, last_schedule_check
    
    print("–õ–û–ì: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–∏...")
    new_schedule = fetch_schedule_data()
    
    if not new_schedule:
        print("–õ–û–ì: –ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è")
        return
    
    # Check if schedule has changed
    if schedule_cache != new_schedule:
        print("–õ–û–ì: –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–∏")
        schedule_cache = new_schedule
        last_schedule_check = datetime.now(YEKATERINBURG_TZ)
        
        # Notify all users about changes
        for group_name in new_schedule.keys():
            users = get_db_connection().execute('SELECT user_id FROM users WHERE group_name = ?', (group_name,)).fetchall()
            for user in users:
                try:
                    await context.bot.send_message(
                        user['user_id'],
                        "üîÑ –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–∏. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É /start –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è."
                    )
                except Exception as e:
                    print(f"–û–®–ò–ë–ö–ê: –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {user['user_id']}: {e}")

async def send_daily_schedule(context: ContextTypes.DEFAULT_TYPE):
    """Sends daily schedule at 19:00"""
    print("–õ–û–ì: –û—Ç–ø—Ä–∞–≤–∫–∞ –µ–∂–µ–¥–Ω–µ–≤–Ω–æ–≥–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è...")
    
    # Send tomorrow's schedule
    for group_name in schedule_cache.keys():
        lessons = schedule_cache[group_name]
        tomorrow_lessons = filter_tomorrow_lessons(lessons)
        
        if tomorrow_lessons:
            schedule_text = format_schedule(tomorrow_lessons, f"üìÖ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –Ω–∞ –∑–∞–≤—Ç—Ä–∞ ({group_name})")
            
            # Add homework information
            homeworks = get_homeworks(group_name)
            if homeworks:
                homework_text = "\n\nüìù <b>–î–æ–º–∞—à–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è –Ω–∞ –∑–∞–≤—Ç—Ä–∞:</b>\n"
                for hw in homeworks[:3]:
                    homework_text += f"‚Ä¢ {hw['subject']}: {hw['task']} (–¥–æ {hw['deadline']})\n"
                schedule_text += homework_text
            
            users = get_db_connection().execute('SELECT user_id FROM users WHERE group_name = ?', (group_name,)).fetchall()
            for user in users:
                try:
                    await context.bot.send_message(user['user_id'], schedule_text, parse_mode='HTML')
                except Exception as e:
                    print(f"–û–®–ò–ë–ö–ê: –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {user['user_id']}: {e}")

async def send_morning_schedule(context: ContextTypes.DEFAULT_TYPE):
    """Sends morning schedule at 07:00"""
    print("–õ–û–ì: –û—Ç–ø—Ä–∞–≤–∫–∞ —É—Ç—Ä–µ–Ω–Ω–µ–≥–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è...")
    
    # Send today's schedule
    for group_name in schedule_cache.keys():
        lessons = schedule_cache[group_name]
        today_lessons = filter_today_lessons(lessons)
        
        if today_lessons:
            schedule_text = format_schedule(today_lessons, f"üìÖ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è ({group_name})")
            
            users = get_db_connection().execute('SELECT user_id FROM users WHERE group_name = ?', (group_name,)).fetchall()
            for user in users:
                try:
                    await context.bot.send_message(user['user_id'], schedule_text, parse_mode='HTML')
                except Exception as e:
                    print(f"–û–®–ò–ë–ö–ê: –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {user['user_id']}: {e}")

async def check_next_lesson(context: ContextTypes.DEFAULT_TYPE):
    """Checks and sends notification about next lesson"""
    print("–õ–û–ì: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–ª–µ–¥—É—é—â–µ–π –ø–∞—Ä—ã...")
    
    now = datetime.now(YEKATERINBURG_TZ)
    current_time = now.time()
    
    for group_name in schedule_cache.keys():
        lessons = schedule_cache[group_name]
        today_lessons = filter_today_lessons(lessons)
        
        if not today_lessons:
            continue
            
        # Find current and next lessons
        for i, lesson in enumerate(today_lessons):
            try:
                lesson_date_utc = datetime.fromisoformat(lesson['date'].replace('Z', '+00:00'))
                lesson_date_yekat = lesson_date_utc.astimezone(YEKATERINBURG_TZ)
                lesson_number = lesson.get('lessonNumber', 0)
                start_time, end_time = get_lesson_time(lesson_number)
                
                # Parse time strings
                end_time_obj = datetime.strptime(end_time, '%H:%M').time()
                
                # Check if lesson just ended (within last minute)
                if (datetime.combine(now.date(), end_time_obj) <= now <= 
                    datetime.combine(now.date(), end_time_obj) + timedelta(minutes=1)):
                    
                    # Check if there's a next lesson
                    if i + 1 < len(today_lessons):
                        next_lesson = today_lessons[i + 1]
                        next_lesson_number = next_lesson.get('lessonNumber', 0)
                        next_start_time, next_end_time = get_lesson_time(next_lesson_number)
                        
                        next_lesson_text = (
                            f"üìÖ <b>–°–ª–µ–¥—É—é—â–∞—è –ø–∞—Ä–∞ ({group_name})</b>\n\n"
                            f"    ‚è∞ {next_start_time}-{next_end_time} | {next_lesson_number} –ø–∞—Ä–∞\n"
                            f"    üìö {next_lesson.get('subjectFull', 'N/A')}\n"
                            f"    üë®‚Äçüè´ {next_lesson.get('teacher', 'N/A')}\n"
                            f"    üö™ {next_lesson.get('room', 'N/A')}\n"
                        )
                        
                        users = get_db_connection().execute('SELECT user_id FROM users WHERE group_name = ?', (group_name,)).fetchall()
                        for user in users:
                            try:
                                await context.bot.send_message(user['user_id'], next_lesson_text, parse_mode='HTML')
                            except Exception as e:
                                print(f"–û–®–ò–ë–ö–ê: –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ —Å–ª–µ–¥—É—é—â–µ–π –ø–∞—Ä–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {user['user_id']}: {e}")
            except Exception as e:
                print(f"–û–®–ò–ë–ö–ê: –ù–µ —É–¥–∞–ª–æ—Å—å –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –ø–∞—Ä—É: {e}")
                continue

# -------------------- CORE BOT FUNCTIONS --------------------

async def start_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Handler for the /start command"""
    user = update.effective_user
    user_id = user.id
    
    add_user(user_id, user.username, user.first_name, user.last_name)
    user_data = get_user(user_id)
    
    # If user doesn't have a valid group, ask for it
    if not user_data or user_data['group_name'] not in ALL_GROUPS:
        return await ask_user_group(update, context)

    print(f"–õ–û–ì: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user.first_name} (ID: {user.id}) –≤–µ—Ä–Ω—É–ª—Å—è –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é.")
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å–æ–≤–ø–∞–¥–∞–µ—Ç –ª–∏ —Ä–æ–ª—å –≤ –±–∞–∑–µ —Å –æ–∂–∏–¥–∞–µ–º–æ–π –¥–ª—è —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    if user_id in SPECIAL_USERS and user_data['role'] != SPECIAL_USERS[user_id]['role']:
        keyboard = [[InlineKeyboardButton("üîÑ –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å —Ä–æ–ª—å", callback_data=f"fix_role_{user_id}")]]
        reply_markup = InlineKeyboardMarkup(keyboard)
        await update.message.reply_text(
            "‚ö†Ô∏è –û–±–Ω–∞—Ä—É–∂–µ–Ω–æ –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Ä–æ–ª–∏. –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ, —á—Ç–æ–±—ã –∏—Å–ø—Ä–∞–≤–∏—Ç—å:",
            reply_markup=reply_markup
        )
    
    await show_main_menu(update, user_id)
    return ConversationHandler.END

async def ask_user_group(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Asks the user to select their group"""
    keyboard = [ALL_GROUPS[i:i+3] for i in range(0, len(ALL_GROUPS), 3)]
    reply_markup = ReplyKeyboardMarkup(keyboard, resize_keyboard=True, one_time_keyboard=True)
    
    await update.message.reply_text(
        "üëã –í—ã–±–µ—Ä–∏ —Å–≤–æ—é –≥—Ä—É–ø–ø—É:",
        reply_markup=reply_markup
    )
    
    return AWAITING_GROUP

async def handle_group_selection(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Handles the user's group selection and ends the conversation"""
    user = update.effective_user
    user_id = user.id
    group_name = update.message.text
    
    if group_name not in ALL_GROUPS:
        await update.message.reply_text(
            "‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏ –≥—Ä—É–ø–ø—É –∏–∑ —Å–ø–∏—Å–∫–∞:",
            reply_markup=ReplyKeyboardMarkup([ALL_GROUPS[i:i+3] for i in range(0, len(ALL_GROUPS), 3)], 
                                           resize_keyboard=True, one_time_keyboard=True)
        )
        print(f"–õ–û–ì: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user.first_name} (ID: {user_id}) –≤–≤–µ–ª –Ω–µ–≤–µ—Ä–Ω—É—é –≥—Ä—É–ø–ø—É: {group_name}")
        return AWAITING_GROUP
    
    update_user_group(user_id, group_name)
    
    await update.message.reply_text(
        f"‚úÖ –ì—Ä—É–ø–ø–∞ {group_name} —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞!",
        reply_markup=ReplyKeyboardRemove()
    )
    
    await show_main_menu(update, user_id)
    print(f"–õ–û–ì: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user.first_name} (ID: {user_id}) —É—Å–ø–µ—à–Ω–æ –≤—ã–±—Ä–∞–ª –≥—Ä—É–ø–ø—É {group_name}.")
    return ConversationHandler.END

async def show_main_menu(update: Update, user_id: int):
    """Displays the main menu based on user rights"""
    user_data = get_user(user_id)
    role = user_data['role']
    
    welcome_text = "üëã –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!"
    
    if user_id in SPECIAL_USERS:
        welcome_text = f"üëë –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, {SPECIAL_USERS[user_id]['name']}!"
    elif role == ROLE_IT_SPECIALIST:
        welcome_text = "üëë –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, –ê–π—Ç–∏—à–Ω–∏–∫!"
    elif role == ROLE_PHYSICAL_ORGANIZER:
        welcome_text = "üèÉ –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, –§–∏–∑. –æ—Ä–≥.!"

    if user_id == DEVELOPER_ID: # Developer-specific menu
        keyboard = [
            ['üìÖ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ', 'üìù –î–ó'],
            ['‚ÑπÔ∏è –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è', 'üí° –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è', 'üí° –ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å –∏–¥–µ—é'],
            ['üì¢ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –î–ó', 'üì¢ –û—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ'],
            ['–£–¥–∞–ª–∏—Ç—å –î–ó', '–£–¥–∞–ª–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ', '–£–¥–∞–ª–∏—Ç—å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è'],
            ['–£–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è'],
            ['üí∞ –î–∞—Ç—å –¥–µ–Ω—é–∂–∫—É'],
            ['üéì –°–º–µ–Ω–∏—Ç—å –≥—Ä—É–ø–ø—É']
        ]
    elif role == ROLE_IT_SPECIALIST:
        keyboard = [
            ['üìÖ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ', 'üìù –î–ó'],
            ['‚ÑπÔ∏è –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è', 'üí° –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è', 'üí° –ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å –∏–¥–µ—é'],
            ['üì¢ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –î–ó', 'üì¢ –û—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ'],
            ['–£–¥–∞–ª–∏—Ç—å –î–ó', '–£–¥–∞–ª–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ', '–£–¥–∞–ª–∏—Ç—å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è'],
            ['üí∞ –î–∞—Ç—å –¥–µ–Ω—é–∂–∫—É'],
            ['üéì –°–º–µ–Ω–∏—Ç—å –≥—Ä—É–ø–ø—É']
        ]
    elif role == ROLE_PHYSICAL_ORGANIZER:
        keyboard = [
            ['üìÖ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ', 'üìù –î–ó'],
            ['‚ÑπÔ∏è –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è', 'üí° –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è', 'üí° –ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å –∏–¥–µ—é'],
            ['üèÉ –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–ø–æ—Ä—Ç–∏–≤–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ'],
            ['üí∞ –î–∞—Ç—å –¥–µ–Ω—é–∂–∫—É'],
            ['üéì –°–º–µ–Ω–∏—Ç—å –≥—Ä—É–ø–ø—É']
        ]
    else: # Student menu
        keyboard = [
            ['üìÖ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ', 'üìù –î–ó'],
            ['‚ÑπÔ∏è –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è', 'üí° –ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å –∏–¥–µ—é'],
            ['üí∞ –î–∞—Ç—å –¥–µ–Ω—é–∂–∫—É'],
            ['üìû –°–≤—è–∑–∞—Ç—å—Å—è —Å–æ —Å—Ç–∞—Ä–æ—Å—Ç–æ–π', 'üìû –°–≤—è–∑–∞—Ç—å—Å—è —Å –∑–∞–º–æ–º —Å—Ç–∞—Ä–æ—Å—Ç—ã'],
            ['üìû –°–≤—è–∑–∞—Ç—å—Å—è —Å —Ñ–∏–∑–æ—Ä–≥–æ–º'],
            ['üéì –°–º–µ–Ω–∏—Ç—å –≥—Ä—É–ø–ø—É']
        ]
    
    reply_markup = ReplyKeyboardMarkup(keyboard, resize_keyboard=True)
    
    message_source = update.callback_query.message if update.callback_query else update.message
    await message_source.reply_text(welcome_text, reply_markup=reply_markup)

    print(f"–õ–û–ì: –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é –ø–æ–∫–∞–∑–∞–Ω–æ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_data['first_name']} (ID: {user_id}).")


async def cancel_conversation(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Cancels the current conversation and returns to the main menu"""
    user = update.effective_user
    user_id = user.id
    
    await update.message.reply_text("–î–µ–π—Å—Ç–≤–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ.", reply_markup=ReplyKeyboardRemove())
    await show_main_menu(update, user_id)
    print(f"–õ–û–ì: –î–∏–∞–ª–æ–≥ –æ—Ç–º–µ–Ω–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º {user.first_name} (ID: {user_id}).")
    return ConversationHandler.END

async def handle_simple_message(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Handler for simple text messages that don't require a conversation"""
    user = update.effective_user
    user_id = user.id
    text = update.message.text
    user_data = get_user(user_id)
    
    print(f"–õ–û–ì: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user.first_name} (ID: {user_id}) –æ—Ç–ø—Ä–∞–≤–∏–ª —Å–æ–æ–±—â–µ–Ω–∏–µ: '{text}'")
    
    if not user_data or user_data['group_name'] not in ALL_GROUPS:
        add_user(user_id, user.username, user.first_name, user.last_name)
        await update.message.reply_text("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–∞–∂–º–∏ /start –∏ –≤—ã–±–µ—Ä–∏ —Å–≤–æ—é –≥—Ä—É–ø–ø—É.")
        return

    role = user_data['role']
    group_name = user_data['group_name']
    
    if text == 'üìÖ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ':
        await show_schedule_periods(update, user_id)
    
    elif text == 'üìù –î–ó':
        await show_homework(update, group_name)
    
    elif text == '‚ÑπÔ∏è –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è':
        await show_information(update, group_name, role)

    elif text == 'üí° –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è' and (role in [ROLE_IT_SPECIALIST, ROLE_PHYSICAL_ORGANIZER] or user_id in SPECIAL_USERS):
        await show_suggestions(update)

    elif text == 'üí∞ –î–∞—Ç—å –¥–µ–Ω—é–∂–∫—É':
        donate_text = "–ï—Å–ª–∏ –Ω–µ –∂–∞–ª–∫–æ, –º–æ–∂–µ—à—å –¥–∞—Ç—å —Ä–∞–∑—Ä–∞–±—É –±–æ—Ç–∞ –¥–µ–Ω—é–∂–∫—É –Ω–∞ –¥–∞–ª—å–Ω–µ–π—à–µ–µ —Ä–∞–∑–≤–∏—Ç–∏–µ –±–æ—Ç–∞ –∏ –Ω–∞ –ø–æ–∫—É—à–∞—Ç—åüòä"
        keyboard = [
            [InlineKeyboardButton("üí∏ –ü–æ–¥–¥–µ—Ä–∂–∞—Ç—å –∞–≤—Ç–æ—Ä–∞", url="https://www.donationalerts.com/r/ax_hikitka")]
        ]
        reply_markup = InlineKeyboardMarkup(keyboard)
        await update.message.reply_text(donate_text, reply_markup=reply_markup)
    
    elif text == 'üìû –°–≤—è–∑–∞—Ç—å—Å—è —Å —Ñ–∏–∑–æ—Ä–≥–æ–º':
        await contact_physical_organizer(update)
    
    elif text == 'üìû –°–≤—è–∑–∞—Ç—å—Å—è —Å–æ —Å—Ç–∞—Ä–æ—Å—Ç–æ–π':
        await contact_starosta(update)

    elif text == 'üìû –°–≤—è–∑–∞—Ç—å—Å—è —Å –∑–∞–º–æ–º —Å—Ç–∞—Ä–æ—Å—Ç—ã':
        await contact_deputy_starosta(update)
    
    elif text in ['üìÖ –°–µ–≥–æ–¥–Ω—è', 'üìÖ –ó–∞–≤—Ç—Ä–∞', 'üìÖ –ù–µ–¥–µ–ª—è', 'üìÖ –í—Å–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ']:
        await handle_schedule_period(update, context, group_name)
    
    elif text == 'üîô –ù–∞–∑–∞–¥':
        await show_main_menu(update, user_id)

    elif text == '–£–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è' and user_id == DEVELOPER_ID:
        await delete_user_menu(update, context)

    elif text == '–£–¥–∞–ª–∏—Ç—å —Å–ø–æ—Ä—Ç–∏–≤–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è' and (user_id == DEVELOPER_ID or role == ROLE_PHYSICAL_ORGANIZER):
        await delete_sport_notification_menu(update, context)

    else:
        await update.message.reply_text("–ò—Å–ø–æ–ª—å–∑—É–π –∫–Ω–æ–ø–∫–∏ –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ üëá")
        print(f"–õ–û–ì: –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞ –æ—Ç {user.first_name} (ID: {user_id}): '{text}'")

# -------------------- SCHEDULE DISPLAY FUNCTIONS --------------------

async def show_schedule_periods(update: Update, user_id: int):
    """Shows the schedule period selection"""
    keyboard = [
        ['üìÖ –°–µ–≥–æ–¥–Ω—è', 'üìÖ –ó–∞–≤—Ç—Ä–∞'],
        ['üìÖ –ù–µ–¥–µ–ª—è', 'üìÖ –í—Å–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ'],
        ['üîô –ù–∞–∑–∞–¥']
    ]
    reply_markup = ReplyKeyboardMarkup(keyboard, resize_keyboard=True)
    await update.message.reply_text("–í—ã–±–µ—Ä–∏ –ø–µ—Ä–∏–æ–¥ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è:", reply_markup=reply_markup)
    print(f"–õ–û–ì: –ü–æ–∫–∞–∑–∞–Ω –≤—ã–±–æ—Ä –ø–µ—Ä–∏–æ–¥–∞ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}.")

async def handle_schedule_period(update: Update, context: ContextTypes.DEFAULT_TYPE, group_name: str):
    """Handles the schedule period selection"""
    text = update.message.text
    print(f"–õ–û–ì: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–ø—Ä–æ—Å–∏–ª —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è –ø–µ—Ä–∏–æ–¥–∞ '{text}'.")
    
    await update.message.reply_text("‚è≥ –ó–∞–≥—Ä—É–∂–∞—é —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ...", reply_markup=ReplyKeyboardRemove())
    schedule = get_schedule(text, group_name)
    await update.message.reply_text(schedule, parse_mode='HTML')
    await show_main_menu(update, update.effective_user.id) # Return to main menu after showing schedule

# -------------------- DATABASE INTERACTION FUNCTIONS --------------------

def add_homework(subject, task, deadline, group_name, added_by, photo_id=None):
    """Adds homework to the database"""
    conn = get_db_connection()
    conn.execute('''INSERT INTO homeworks (subject, task, deadline, group_name, added_by, photo_id)
                 VALUES (?, ?, ?, ?, ?, ?)''', (subject, task, deadline, group_name, added_by, photo_id))
    conn.commit()
    conn.close()
    print(f"–õ–û–ì: –î–æ–±–∞–≤–ª–µ–Ω–æ –î–ó –¥–ª—è –≥—Ä—É–ø–ø—ã {group_name}.")

def get_homeworks(group_name):
    """Gets homework for a group"""
    conn = get_db_connection()
    homeworks = conn.execute('''SELECT h.*, u.first_name 
                             FROM homeworks h JOIN users u ON h.added_by = u.user_id 
                             WHERE h.group_name = ? ORDER BY h.created_at DESC''', (group_name,)).fetchall()
    conn.close()
    return homeworks

def add_notification(message, group_name, added_by, photo_id=None):
    """Adds a notification to the database"""
    conn = get_db_connection()
    conn.execute('''INSERT INTO notifications (message, group_name, added_by, photo_id)
                 VALUES (?, ?, ?, ?)''', (message, group_name, added_by, photo_id))
    conn.commit()
    conn.close()
    print(f"–õ–û–ì: –î–æ–±–∞–≤–ª–µ–Ω–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –¥–ª—è –≥—Ä—É–ø–ø—ã {group_name}.")

def get_notifications(group_name):
    """Gets notifications for a group"""
    conn = get_db_connection()
    notifications = conn.execute('''SELECT n.*, u.first_name 
                                 FROM notifications n JOIN users u ON n.added_by = u.user_id 
                                 WHERE n.group_name = ? ORDER BY n.created_at DESC''', (group_name,)).fetchall()
    conn.close()
    return notifications

def add_sport_notification(message, group_name, added_by, photo_id=None):
    """Adds a sport notification to the database"""
    conn = get_db_connection()
    conn.execute('''INSERT INTO sport_notifications (message, group_name, added_by, photo_id)
                 VALUES (?, ?, ?, ?)''', (message, group_name, added_by, photo_id))
    conn.commit()
    conn.close()
    print(f"–õ–û–ì: –î–æ–±–∞–≤–ª–µ–Ω–æ —Å–ø–æ—Ä—Ç–∏–≤–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –¥–ª—è –≥—Ä—É–ø–ø—ã {group_name}.")

def get_sport_notifications(group_name):
    """Gets sport notifications for a group"""
    conn = get_db_connection()
    notifications = conn.execute('''SELECT s.*, u.first_name 
                                 FROM sport_notifications s JOIN users u ON s.added_by = u.user_id 
                                 WHERE s.group_name = ? ORDER BY s.created_at DESC''', (group_name,)).fetchall()
    conn.close()
    return notifications

def add_suggestion(user_id, message):
    """Adds a suggestion to the database"""
    conn = get_db_connection()
    conn.execute('INSERT INTO suggestions (user_id, message) VALUES (?, ?)', (user_id, message))
    conn.commit()
    conn.close()
    print(f"–õ–û–ì: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} –æ—Ç–ø—Ä–∞–≤–∏–ª –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ.")

def get_suggestions():
    """Gets all suggestions"""
    conn = get_db_connection()
    suggestions = conn.execute('''SELECT s.*, u.first_name, u.username 
                               FROM suggestions s JOIN users u ON s.user_id = u.user_id 
                               ORDER BY s.created_at DESC''').fetchall()
    conn.close()
    return suggestions

# -------------------- MESSAGE SENDING (DIALOG) FUNCTIONS --------------------

async def ask_homework_details(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Asks for homework details to send"""
    await update.message.reply_text(
        "üìù <b>–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –î–ó</b>\n\n"
        "–ù–∞–ø–∏—à–∏ –≤ —Ñ–æ—Ä–º–∞—Ç–µ:\n"
        "<b>–ü—Ä–µ–¥–º–µ—Ç</b>\n"
        "<b>–ó–∞–¥–∞–Ω–∏–µ</b>\n"
        "<b>–°—Ä–æ–∫ —Å–¥–∞—á–∏</b>\n\n"
        "–ü—Ä–∏–º–µ—Ä:\n"
        "–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞\n"
        "–†–µ—à–∏—Ç—å –∑–∞–¥–∞—á–∏ 1-10 –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ 45\n"
        "–î–æ 15.09\n\n"
        "–ú–æ–∂–Ω–æ –ø—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–æ—Ç–æ –∫ —Å–æ–æ–±—â–µ–Ω–∏—é",
        parse_mode='HTML',
        reply_markup=ReplyKeyboardMarkup([['‚ùå –û—Ç–º–µ–Ω–∞']], resize_keyboard=True)
    )
    print(f"–õ–û–ì: –ó–∞–ø—Ä–æ—à–µ–Ω –≤–≤–æ–¥ –î–ó –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {update.effective_user.id}.")
    return AWAITING_HOMEWORK

async def ask_notification_details(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Asks for information to send to everyone"""
    await update.message.reply_text(
        "üì¢ <b>–û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤—Å–µ–º</b>\n\n"
        "–ù–∞–ø–∏—à–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ, –∫–æ—Ç–æ—Ä–æ–µ –Ω—É–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –≤—Å–µ–º —É—á–µ–Ω–∏–∫–∞–º.\n"
        "–ú–æ–∂–Ω–æ –ø—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–æ—Ç–æ –∫ —Å–æ–æ–±—â–µ–Ω–∏—é:",
        parse_mode='HTML',
        reply_markup=ReplyKeyboardMarkup([['‚ùå –û—Ç–º–µ–Ω–∞']], resize_keyboard=True)
    )
    print(f"–õ–û–ì: –ó–∞–ø—Ä–æ—à–µ–Ω –≤–≤–æ–¥ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {update.effective_user.id}.")
    return AWAITING_INFO

async def ask_sport_notification_details(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Asks for a sport notification to send"""
    await update.message.reply_text(
        "üèÉ <b>–û—Ç–ø—Ä–∞–≤–∫–∞ —Å–ø–æ—Ä—Ç–∏–≤–Ω–æ–≥–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</b>\n\n"
        "–ù–∞–ø–∏—à–∏ —Å–ø–æ—Ä—Ç–∏–≤–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ, –∫–æ—Ç–æ—Ä–æ–µ –Ω—É–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –≤—Å–µ–º —É—á–µ–Ω–∏–∫–∞–º.\n"
        "–ú–æ–∂–Ω–æ –ø—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–æ—Ç–æ –∫ —Å–æ–æ–±—â–µ–Ω–∏—é:",
        parse_mode='HTML',
        reply_markup=ReplyKeyboardMarkup([['‚ùå –û—Ç–º–µ–Ω–∞']], resize_keyboard=True)
    )
    print(f"–õ–û–ì: –ó–∞–ø—Ä–æ—à–µ–Ω –≤–≤–æ–¥ —Å–ø–æ—Ä—Ç–∏–≤–Ω–æ–≥–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {update.effective_user.id}.")
    return AWAITING_SPORT

async def ask_suggestion_details(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Asks for a suggestion to improve the bot"""
    await update.message.reply_text(
        "üí° <b>–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –ø–æ —É–ª—É—á—à–µ–Ω–∏—é –±–æ—Ç–∞</b>\n\n"
        "–ù–∞–ø–∏—à–∏ —Å–≤–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –ø–æ —É–ª—É—á—à–µ–Ω–∏—é –±–æ—Ç–∞:\n\n"
        "–ß—Ç–æ –±—ã —Ç—ã —Ö–æ—Ç–µ–ª –¥–æ–±–∞–≤–∏—Ç—å –∏–ª–∏ –∏–∑–º–µ–Ω–∏—Ç—å?",
        parse_mode='HTML',
        reply_markup=ReplyKeyboardMarkup([['‚ùå –û—Ç–º–µ–Ω–∞']], resize_keyboard=True)
    )
    print(f"–õ–û–ì: –ó–∞–ø—Ä–æ—à–µ–Ω –≤–≤–æ–¥ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {update.effective_user.id}.")
    return AWAITING_SUGGESTION

# --- UPDATED MESSAGE HANDLING FUNCTIONS IN DIALOGS ---

async def handle_homework_input(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id
    user_data = get_user(user_id)
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞ —á–µ—Ä–µ–∑ SPECIAL_USERS, –∞ –Ω–µ —á–µ—Ä–µ–∑ —Ä–æ–ª—å –≤ –±–∞–∑–µ
    if user_id not in [uid for uid in SPECIAL_USERS if SPECIAL_USERS[uid]['role'] == ROLE_IT_SPECIALIST]:
        await update.message.reply_text("–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è —ç—Ç–æ–≥–æ –¥–µ–π—Å—Ç–≤–∏—è.")
        return await cancel_conversation(update, context)

    group_name = user_data['group_name']
    
    photo_id = update.message.photo[-1].file_id if update.message.photo else None
    text = update.message.caption if update.message.caption else update.message.text
    
    if text == '‚ùå –û—Ç–º–µ–Ω–∞':
        return await cancel_conversation(update, context)

    if not text:
        await update.message.reply_text("‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –¥–æ–±–∞–≤—å –æ–ø–∏—Å–∞–Ω–∏–µ –∫ –î–ó.")
        return AWAITING_HOMEWORK

    lines = text.strip().split('\n')
    if len(lines) >= 3:
        subject = lines[0].strip()
        task = lines[1].strip()
        deadline = lines[2].strip()
        
        add_homework(subject, task, deadline, group_name, user_id, photo_id)
        await update.message.reply_text("‚úÖ –î–ó –¥–æ–±–∞–≤–ª–µ–Ω–æ –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è...", reply_markup=ReplyKeyboardRemove())
        await send_homework_to_all(context.bot, subject, task, deadline, group_name, user_id, photo_id)
        print(f"–õ–û–ì: –î–ó –¥–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º {user_id} –¥–ª—è –≥—Ä—É–ø–ø—ã {group_name}.")
        
        await show_main_menu(update, user_id)
        return ConversationHandler.END
    else:
        await update.message.reply_text("‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç. –ù—É–∂–Ω–æ 3 —Å—Ç—Ä–æ–∫–∏: –ø—Ä–µ–¥–º–µ—Ç, –∑–∞–¥–∞–Ω–∏–µ, —Å—Ä–æ–∫")
        return AWAITING_HOMEWORK

async def handle_notification_input(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id
    user_data = get_user(user_id)
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞ —á–µ—Ä–µ–∑ SPECIAL_USERS, –∞ –Ω–µ —á–µ—Ä–µ–∑ —Ä–æ–ª—å –≤ –±–∞–∑–µ
    if user_id not in [uid for uid in SPECIAL_USERS if SPECIAL_USERS[uid]['role'] == ROLE_IT_SPECIALIST]:
        await update.message.reply_text("–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è —ç—Ç–æ–≥–æ –¥–µ–π—Å—Ç–≤–∏—è.")
        return await cancel_conversation(update, context)

    group_name = user_data['group_name']
    
    photo_id = update.message.photo[-1].file_id if update.message.photo else None
    message_text = update.message.caption if update.message.caption else update.message.text

    if message_text == '‚ùå –û—Ç–º–µ–Ω–∞':
        return await cancel_conversation(update, context)

    if not message_text:
        await update.message.reply_text("‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –¥–æ–±–∞–≤—å —Ç–µ–∫—Å—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è.")
        return AWAITING_INFO

    add_notification(message_text, group_name, user_id, photo_id)
    await update.message.reply_text("‚úÖ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è...", reply_markup=ReplyKeyboardRemove())
    await send_notification_to_all(context.bot, message_text, group_name, user_id, photo_id)
    print(f"–õ–û–ì: –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º {user_id} –¥–ª—è –≥—Ä—É–ø–ø—ã {group_name}.")
    
    await show_main_menu(update, user_id)
    return ConversationHandler.END

async def handle_sport_input(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id
    user_data = get_user(user_id)
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞ —á–µ—Ä–µ–∑ SPECIAL_USERS, –∞ –Ω–µ —á–µ—Ä–µ–∑ —Ä–æ–ª—å –≤ –±–∞–∑–µ
    if user_id not in [uid for uid in SPECIAL_USERS if SPECIAL_USERS[uid]['role'] == ROLE_PHYSICAL_ORGANIZER]:
        await update.message.reply_text("–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è —ç—Ç–æ–≥–æ –¥–µ–π—Å—Ç–≤–∏—è.")
        return await cancel_conversation(update, context)

    group_name = user_data['group_name']

    photo_id = update.message.photo[-1].file_id if update.message.photo else None
    message_text = update.message.caption if update.message.caption else update.message.text

    if message_text == '‚ùå –û—Ç–º–µ–Ω–∞':
        return await cancel_conversation(update, context)

    if not message_text:
        await update.message.reply_text("‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –¥–æ–±–∞–≤—å —Ç–µ–∫—Å—Ç —Å–ø–æ—Ä—Ç–∏–≤–Ω–æ–≥–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è.")
        return AWAITING_SPORT
    
    add_sport_notification(message_text, group_name, user_id, photo_id)
    await update.message.reply_text("‚úÖ –°–ø–æ—Ä—Ç–∏–≤–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è...", reply_markup=ReplyKeyboardRemove())
    await send_sport_notification_to_all(context.bot, message_text, group_name, user_id, photo_id)
    print(f"–õ–û–ì: –°–ø–æ—Ä—Ç–∏–≤–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º {user_id} –¥–ª—è –≥—Ä—É–ø–ø—ã {group_name}.")
    
    await show_main_menu(update, user_id)
    return ConversationHandler.END

async def handle_suggestion_input(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id
    user_data = get_user(user_id)
    text = update.message.text

    if text == '‚ùå –û—Ç–º–µ–Ω–∞':
        return await cancel_conversation(update, context)
    
    if not text:
        await update.message.reply_text("‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–∞–ø–∏—à–∏ —Å–≤–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ.")
        return AWAITING_SUGGESTION

    add_suggestion(user_id, text)
    
    for special_id in SPECIAL_USERS:
        try:
            await context.bot.send_message(
                special_id,
                f"üí° –ù–æ–≤–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –æ—Ç {user_data['first_name']} (@{user_data['username']}):\n\n{text}"
            )
        except Exception as e:
            print(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {special_id}: {e}")
    
    await update.message.reply_text("‚úÖ –°–ø–∞—Å–∏–±–æ –∑–∞ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ! –ú—ã –µ–≥–æ —Ä–∞—Å—Å–º–æ—Ç—Ä–∏–º.", reply_markup=ReplyKeyboardRemove())
    await show_main_menu(update, user_id)
    print(f"–õ–û–ì: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} –æ—Ç–ø—Ä–∞–≤–∏–ª –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ.")
    return ConversationHandler.END

# --- NOTIFICATION SENDING LOGIC ---

async def send_homework_to_all(bot, subject, task, deadline, group_name, added_by, photo_id=None):
    """Sends homework to all users in a group"""
    homework_text = (
        f"üìù <b>–ù–û–í–û–ï –î–û–ú–ê–®–ù–ï–ï –ó–ê–î–ê–ù–ò–ï</b>\n\n"
        f"üìö <b>–ü—Ä–µ–¥–º–µ—Ç:</b> {subject}\n"
        f"üìã <b>–ó–∞–¥–∞–Ω–∏–µ:</b> {task}\n"
        f"‚è∞ <b>–°—Ä–æ–∫ —Å–¥–∞—á–∏:</b> {deadline}\n"
        f"üë• <b>–ì—Ä—É–ø–ø–∞:</b> {group_name}\n"
    )
    
    users = get_db_connection().execute('SELECT user_id FROM users WHERE group_name = ?', (group_name,)).fetchall()
    
    for user in users:
        try:
            if photo_id:
                await bot.send_photo(chat_id=user['user_id'], photo=photo_id, caption=homework_text, parse_mode='HTML')
            else:
                await bot.send_message(user['user_id'], homework_text, parse_mode='HTML')
        except Exception as e:
            print(f"–û–®–ò–ë–ö–ê: –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –î–ó –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {user['user_id']}: {e}")

async def send_notification_to_all(bot, message, group_name, added_by, photo_id=None):
    """Sends a notification to all users in a group"""
    notification_text = (f"üì¢ <b>–í–ê–ñ–ù–û–ï –£–í–ï–î–û–ú–õ–ï–ù–ò–ï</b>\n\n{message}\n\nüë• <b>–ì—Ä—É–ø–ø–∞:</b> {group_name}")
    users = get_db_connection().execute('SELECT user_id FROM users WHERE group_name = ?', (group_name,)).fetchall()
    
    for user in users:
        try:
            if photo_id:
                await bot.send_photo(chat_id=user['user_id'], photo=photo_id, caption=notification_text, parse_mode='HTML')
            else:
                await bot.send_message(user['user_id'], notification_text, parse_mode='HTML')
        except Exception as e:
            print(f"–û–®–ò–ë–ö–ê: –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {user['user_id']}: {e}")

async def send_sport_notification_to_all(bot, message, group_name, added_by, photo_id=None):
    """Sends a sport notification to all users in a group"""
    sport_text = (f"üèÉ <b>–°–ü–û–†–¢–ò–í–ù–û–ï –£–í–ï–î–û–ú–õ–ï–ù–ò–ï</b>\n\n{message}\n\nüë• <b>–ì—Ä—É–ø–ø–∞:</b> {group_name}")
    users = get_db_connection().execute('SELECT user_id FROM users WHERE group_name = ?', (group_name,)).fetchall()

    for user in users:
        try:
            if photo_id:
                await bot.send_photo(chat_id=user['user_id'], photo=photo_id, caption=sport_text, parse_mode='HTML')
            else:
                await bot.send_message(user['user_id'], sport_text, parse_mode='HTML')
        except Exception as e:
            print(f"–û–®–ò–ë–ö–ê: –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–ø–æ—Ä—Ç–∏–≤–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {user['user_id']}: {e}")

# -------------------- INFO DISPLAY FUNCTIONS --------------------

async def show_homework(update: Update, group_name: str):
    """Shows all homework for a group"""
    homeworks = get_homeworks(group_name)
    if not homeworks:
        await update.message.reply_text("üì≠ –ü–æ–∫–∞ –Ω–µ—Ç –¥–æ–º–∞—à–Ω–∏—Ö –∑–∞–¥–∞–Ω–∏–π")
        return
    
    for hw in homeworks[:3]: # Show recent 3
        hw_text = (
            f"üìù <b>–î–æ–º–∞—à–Ω–µ–µ –∑–∞–¥–∞–Ω–∏–µ</b>\n"
            f"üìö <b>–ü—Ä–µ–¥–º–µ—Ç:</b> {hw['subject']}\n"
            f"üìã <b>–ó–∞–¥–∞–Ω–∏–µ:</b> {hw['task']}\n"
            f"‚è∞ <b>–°—Ä–æ–∫:</b> {hw['deadline']}\n"
            f"üë§ <b>–î–æ–±–∞–≤–∏–ª:</b> {hw['first_name']}\n"
            f"üìÖ <b>–î–∞—Ç–∞:</b> {datetime.fromisoformat(hw['created_at']).strftime('%d.%m.%Y %H:%M')}"
        )
        if hw['photo_id']:
            await update.message.reply_photo(photo=hw['photo_id'], caption=hw_text, parse_mode='HTML')
        else:
            await update.message.reply_text(hw_text, parse_mode='HTML')
    
    if len(homeworks) > 3:
        await update.message.reply_text(f"üìä <b>–ü–æ–∫–∞–∑–∞–Ω–æ 3 –∏–∑ {len(homeworks)} –∑–∞–¥–∞–Ω–∏–π</b>", parse_mode='HTML')

async def show_information(update: Update, group_name: str, role: str):
    """Shows information for the user"""
    user_count = get_total_user_count()
    info_text = f"üìä <b>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ –±–æ—Ç–µ:</b> {user_count}\n\n<b>–ö–æ–Ω—Ç–∞–∫—Ç—ã:</b>\n"
    for data in SPECIAL_USERS.values():
        info_text += f"- <b>{data['name']}</b>: {data['username']}\n"
    await update.message.reply_text(info_text, parse_mode='HTML')

    notifications = get_notifications(group_name)
    sport_notifications = get_sport_notifications(group_name)
    if not notifications and not sport_notifications:
        await update.message.reply_text("üì≠ –ü–æ–∫–∞ –Ω–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π")
        return
    
    if notifications:
        await update.message.reply_text("üì¢ <b>–í–∞–∂–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è:</b>", parse_mode='HTML')
        for notif in notifications[:2]:
            notif_text = f"{notif['message']}\n\nüë§ <b>–û—Ç:</b> {notif['first_name']} | üìÖ {datetime.fromisoformat(notif['created_at']).strftime('%d.%m.%Y')}"
            if notif['photo_id']:
                await update.message.reply_photo(photo=notif['photo_id'], caption=notif_text)
            else:
                await update.message.reply_text(notif_text)
    
    if sport_notifications:
        await update.message.reply_text("üèÉ <b>–°–ø–æ—Ä—Ç–∏–≤–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è:</b>", parse_mode='HTML')
        for sport in sport_notifications[:2]:
            sport_text = f"{sport['message']}\n\nüë§ <b>–û—Ç:</b> {sport['first_name']} | üìÖ {datetime.fromisoformat(sport['created_at']).strftime('%d.%m.%Y')}"
            if sport['photo_id']:
                await update.message.reply_photo(photo=sport['photo_id'], caption=sport_text)
            else:
                await update.message.reply_text(sport_text)

async def show_suggestions(update: Update):
    """Shows suggestions from students"""
    suggestions = get_suggestions()
    if not suggestions:
        await update.message.reply_text("üì≠ –ü–æ–∫–∞ –Ω–µ—Ç –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π –æ—Ç —É—á–µ–Ω–∏–∫–æ–≤")
        return
    
    suggestions_text = "üí° <b>–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –æ—Ç —É—á–µ–Ω–∏–∫–æ–≤</b>\n\n"
    for i, s in enumerate(suggestions[:5], 1):
        username = f"@{s['username']}" if s['username'] else s['first_name']
        suggestions_text += f"{i}. {s['message']}\nüë§ {username} | üìÖ {datetime.fromisoformat(s['created_at']).strftime('%d.%m.%Y')}\n\n"
    await update.message.reply_text(suggestions_text, parse_mode='HTML')

async def contact_physical_organizer(update: Update):
    """Contact the physical organizer"""
    username = next((data['username'] for data in SPECIAL_USERS.values() if data['role'] == ROLE_PHYSICAL_ORGANIZER), None)
    if username:
        await update.message.reply_text(f"üèÉ <b>–°–≤—è–∑—å —Å –§–∏–∑. –æ—Ä–≥–æ–º</b>\n\nüìû Telegram: {username}", parse_mode='HTML')
    else:
        await update.message.reply_text("‚ùå –§–∏–∑. –æ—Ä–≥. –Ω–µ –Ω–∞–π–¥–µ–Ω")

async def contact_starosta(update: Update):
    """Contact the —Å—Ç–∞—Ä–æ—Å—Ç–∞"""
    username = next((data['username'] for data in SPECIAL_USERS.values() if data['name'] == '–°—Ç–∞—Ä–æ—Å—Ç–∞'), None)
    if username:
        await update.message.reply_text(f"üëë <b>–°–≤—è–∑—å —Å–æ —Å—Ç–∞—Ä–æ—Å—Ç–æ–π</b>\n\nüìû Telegram: {username}", parse_mode='HTML')
    else:
        await update.message.reply_text("‚ùå –°—Ç–∞—Ä–æ—Å—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω")

async def contact_deputy_starosta(update: Update):
    """Contact the –∑–∞–º —Å—Ç–∞—Ä–æ—Å—Ç—ã"""
    username = next((data['username'] for data in SPECIAL_USERS.values() if data['name'] == '–ó–∞–º –°—Ç–∞—Ä–æ—Å—Ç—ã'), None)
    if username:
        await update.message.reply_text(f"üëë <b>–°–≤—è–∑—å —Å –∑–∞–º–æ–º —Å—Ç–∞—Ä–æ—Å—Ç—ã (—Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–º)</b>\n\nüìû Telegram: {username}", parse_mode='HTML')
    else:
        await update.message.reply_text("‚ùå –ó–∞–º —Å—Ç–∞—Ä–æ—Å—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω")

# -------------------- DELETION FUNCTIONS --------------------

async def delete_homework_menu(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id
    user_data = get_user(user_id)
    if user_id != DEVELOPER_ID and (not user_data or user_data['role'] != ROLE_IT_SPECIALIST):
        await update.message.reply_text("–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è —ç—Ç–æ–≥–æ –¥–µ–π—Å—Ç–≤–∏—è.")
        return ConversationHandler.END
        
    homeworks = get_homeworks(user_data['group_name'])
    if not homeworks:
        await update.message.reply_text("üìù –ù–µ—Ç –¥–æ–º–∞—à–Ω–∏—Ö –∑–∞–¥–∞–Ω–∏–π –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è.")
        return ConversationHandler.END
    
    keyboard = [[InlineKeyboardButton(f"‚ùå {hw['subject']} | {hw['deadline']}", callback_data=f"del_hw_{hw['id']}")] for hw in homeworks[:5]]
    await update.message.reply_text("–í—ã–±–µ—Ä–∏—Ç–µ –î–ó –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è:", reply_markup=InlineKeyboardMarkup(keyboard))
    return AWAITING_HOMEWORK_DELETE

async def delete_notification_menu(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id
    user_data = get_user(user_id)
    if user_id != DEVELOPER_ID and (not user_data or user_data['role'] != ROLE_IT_SPECIALIST):
        await update.message.reply_text("–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è —ç—Ç–æ–≥–æ –¥–µ–π—Å—Ç–≤–∏—è.")
        return ConversationHandler.END
        
    user_data = get_user(user_id)
    notifications = get_notifications(user_data['group_name'])
    sport_notifications = get_sport_notifications(user_data['group_name'])
    
    if not notifications and not sport_notifications:
        await update.message.reply_text("üì¢ –ù–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è.")
        return ConversationHandler.END

    keyboard = []
    # Add regular notifications
    for n in notifications[:5]:
        button_text = f"üì¢ {n['message'][:20]}..."
        keyboard.append([InlineKeyboardButton(button_text, callback_data=f"del_notif_{n['id']}")])
    
    # Add sport notifications
    for s in sport_notifications[:5]:
        button_text = f"üèÉ {s['message'][:20]}..."
        keyboard.append([InlineKeyboardButton(button_text, callback_data=f"del_sport_{s['id']}")])

    await update.message.reply_text("–í—ã–±–µ—Ä–∏—Ç–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è:", reply_markup=InlineKeyboardMarkup(keyboard))
    return AWAITING_INFO_DELETE

async def delete_sport_notification_menu(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id
    user_data = get_user(user_id)
    if user_id != DEVELOPER_ID and (not user_data or user_data['role'] != ROLE_PHYSICAL_ORGANIZER):
        await update.message.reply_text("–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è —ç—Ç–æ–≥–æ –¥–µ–π—Å—Ç–≤–∏—è.")
        return ConversationHandler.END
        
    if user_id == DEVELOPER_ID:
        sport_notifications = get_all_sport_notifications()
    else:
        sport_notifications = get_sport_notifications(user_data['group_name'])

    if not sport_notifications:
        await update.message.reply_text("üèÉ –ù–µ—Ç —Å–ø–æ—Ä—Ç–∏–≤–Ω—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è.")
        return ConversationHandler.END

    keyboard = []
    for sport in sport_notifications[:10]:
        button_text = f"üèÉ {sport['message'][:20]}..."
        keyboard.append([InlineKeyboardButton(button_text, callback_data=f"del_sport_{sport['id']}")])

    await update.message.reply_text("–í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–æ—Ä—Ç–∏–≤–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è:", reply_markup=InlineKeyboardMarkup(keyboard))
    return AWAITING_SPORT_DELETE

async def delete_user_menu(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id
    if user_id != DEVELOPER_ID:
        await update.message.reply_text("–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è —ç—Ç–æ–≥–æ –¥–µ–π—Å—Ç–≤–∏—è.")
        return ConversationHandler.END
        
    users = [u for u in get_all_users() if u['user_id'] not in SPECIAL_USERS]
    if not users:
        await update.message.reply_text("üë• –ù–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è.")
        return ConversationHandler.END
        
    keyboard = [[InlineKeyboardButton(f"‚ùå {u['first_name']} (@{u['username']}) - –ì—Ä—É–ø–ø–∞: {u['group_name']} - ID: {u['user_id']}", callback_data=f"del_user_{u['user_id']}")] for u in users]
    await update.message.reply_text("–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è:", reply_markup=InlineKeyboardMarkup(keyboard))
    return AWAITING_USER_DELETE

async def delete_suggestions_menu(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id
    user_data = get_user(user_id)
    if user_id != DEVELOPER_ID and (not user_data or user_data['role'] not in [ROLE_IT_SPECIALIST, ROLE_PHYSICAL_ORGANIZER]):
        await update.message.reply_text("–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è —ç—Ç–æ–≥–æ –¥–µ–π—Å—Ç–≤–∏—è.")
        return ConversationHandler.END
        
    suggestions = get_suggestions()
    if not suggestions:
        await update.message.reply_text("üí° –ù–µ—Ç –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è.")
        return ConversationHandler.END
    
    keyboard = [[InlineKeyboardButton(f"‚ùå {s['message'][:20]}...", callback_data=f"del_sugg_{s['id']}")] for s in suggestions[:5]]
    await update.message.reply_text("–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è:", reply_markup=InlineKeyboardMarkup(keyboard))
    return AWAITING_SUGGESTION_DELETE

async def handle_delete_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()

    parts = query.data.split('_')
    action = parts[0]
    data_type = parts[1]
    item_id = int(parts[2])
    
    message = "‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞."
    try:
        if data_type == 'hw':
            delete_homework(item_id)
            message = "‚úÖ –î–æ–º–∞—à–Ω–µ–µ –∑–∞–¥–∞–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω–æ."
        elif data_type == 'notif':
            delete_notification(item_id)
            message = "‚úÖ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω–æ."
        elif data_type == 'sport':
            delete_sport_notification(item_id)
            message = "‚úÖ –°–ø–æ—Ä—Ç–∏–≤–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω–æ."
        elif data_type == 'user':
            delete_user(item_id)
            message = "‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω."
        elif data_type == 'sugg':
            delete_suggestion(item_id)
            message = "‚úÖ –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω–æ."
        
        await query.edit_message_text(text=message)
    except Exception as e:
        await query.edit_message_text(text=f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏: {e}")
    
    await show_main_menu(update, query.from_user.id)
    return ConversationHandler.END

# -------------------- ROLE FIX FUNCTION --------------------

async def handle_role_fix_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Handles the role fix callback"""
    query = update.callback_query
    await query.answer()
    
    parts = query.data.split('_')
    user_id = int(parts[2])
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∑–∞–ø—Ä–æ—Å –æ—Ç —Ç–æ–≥–æ –∂–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    if query.from_user.id != user_id:
        await query.edit_message_text("‚ùå –í—ã –Ω–µ –º–æ–∂–µ—Ç–µ –∏—Å–ø—Ä–∞–≤–∏—Ç—å —Ä–æ–ª—å –¥—Ä—É–≥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.")
        return
    
    # –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    user = query.from_user
    add_user(user_id, user.username, user.first_name, user.last_name)
    
    await query.edit_message_text("‚úÖ –í–∞—à–∞ —Ä–æ–ª—å –±—ã–ª–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞! –¢–µ–ø–µ—Ä—å —É –≤–∞—Å –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –≤—Å–µ –ø—Ä–∞–≤–∞.")
    await show_main_menu(update, user_id)

# -------------------- JOB QUEUE FUNCTIONS --------------------

# –ò–°–ü–†–ê–í–õ–ï–ù–û: –§—É–Ω–∫—Ü–∏—è —Ç–µ–ø–µ—Ä—å –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –∞—Ä–≥—É–º–µ–Ω—Ç 'application', –∫–∞–∫ —Ç–æ–≥–æ —Ç—Ä–µ–±—É–µ—Ç post_init
async def init_schedule_cache(application):
    """Initializes the schedule cache"""
    global schedule_cache, last_schedule_check
    schedule_data = fetch_schedule_data()
    if schedule_data:
        schedule_cache = schedule_data
        last_schedule_check = datetime.now(YEKATERINBURG_TZ)
        print("–õ–û–ì: –ö—ç—à —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω")

# -------------------- MAIN FUNCTION --------------------

def main():
    """Main function to run the bot"""
    init_db()
    
    # –ò–°–ü–†–ê–í–õ–ï–ù–û: –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫—ç—à–∞ –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è –≤ post_init
    app = Application.builder().token(BOT_TOKEN).post_init(init_schedule_cache).build()
    
    # Add job queue handlers
    job_queue = app.job_queue
    job_queue.run_repeating(check_schedule_changes, interval=3600, first=10)  # Check every hour
    job_queue.run_daily(send_daily_schedule, time=datetime.strptime("19:00", "%H:%M").time(), days=(0, 1, 2, 3, 4, 5, 6))
    job_queue.run_daily(send_morning_schedule, time=datetime.strptime("07:00", "%H:%M").time(), days=(0, 1, 2, 3, 4, 5, 6))
    job_queue.run_repeating(check_next_lesson, interval=60, first=10)  # Check every minute
    
    # ConversationHandler for managing dialogs
    conv_handler = ConversationHandler(
        entry_points=[
            CommandHandler('start', start_command),
            MessageHandler(filters.Regex('^üì¢ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –î–ó$') & filters.User(SPECIAL_USERS.keys()), ask_homework_details),
            MessageHandler(filters.Regex('^üì¢ –û—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ$') & filters.User(SPECIAL_USERS.keys()), ask_notification_details),
            MessageHandler(filters.Regex('^üèÉ –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–ø–æ—Ä—Ç–∏–≤–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ$') & filters.User(SPECIAL_USERS.keys()), ask_sport_notification_details),
            MessageHandler(filters.Regex('^üí° –ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å –∏–¥–µ—é$'), ask_suggestion_details),
            MessageHandler(filters.Regex('^–£–¥–∞–ª–∏—Ç—å –î–ó$') & (filters.User(SPECIAL_USERS.keys()) | filters.User(user_id=DEVELOPER_ID)), delete_homework_menu),
            MessageHandler(filters.Regex('^–£–¥–∞–ª–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ$') & (filters.User(SPECIAL_USERS.keys()) | filters.User(user_id=DEVELOPER_ID)), delete_notification_menu),
            MessageHandler(filters.Regex('^–£–¥–∞–ª–∏—Ç—å —Å–ø–æ—Ä—Ç–∏–≤–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è$') & (filters.User(SPECIAL_USERS.keys()) | filters.User(user_id=DEVELOPER_ID)), delete_sport_notification_menu),
            MessageHandler(filters.Regex('^–£–¥–∞–ª–∏—Ç—å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è$') & (filters.User(SPECIAL_USERS.keys()) | filters.User(user_id=DEVELOPER_ID)), delete_suggestions_menu),
            MessageHandler(filters.Regex('^–£–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è$') & filters.User(user_id=DEVELOPER_ID), delete_user_menu),
            MessageHandler(filters.Regex('^üéì –°–º–µ–Ω–∏—Ç—å –≥—Ä—É–ø–ø—É$'), ask_user_group),
        ],
        states={
            AWAITING_GROUP: [MessageHandler(filters.TEXT & ~filters.COMMAND, handle_group_selection)],
            AWAITING_HOMEWORK: [MessageHandler(filters.TEXT | filters.PHOTO, handle_homework_input)],
            AWAITING_INFO: [MessageHandler(filters.TEXT | filters.PHOTO, handle_notification_input)],
            AWAITING_SPORT: [MessageHandler(filters.TEXT | filters.PHOTO, handle_sport_input)],
            AWAITING_SUGGESTION: [MessageHandler(filters.TEXT & ~filters.COMMAND, handle_suggestion_input)],
            AWAITING_HOMEWORK_DELETE: [CallbackQueryHandler(handle_delete_callback, pattern='^del_hw_')],
            AWAITING_INFO_DELETE: [CallbackQueryHandler(handle_delete_callback, pattern='^del_notif_')],
            AWAITING_SPORT_DELETE: [CallbackQueryHandler(handle_delete_callback, pattern='^del_sport_')],
            AWAITING_USER_DELETE: [CallbackQueryHandler(handle_delete_callback, pattern='^del_user_')],
            AWAITING_SUGGESTION_DELETE: [CallbackQueryHandler(handle_delete_callback, pattern='^del_sugg_')]
        },
        fallbacks=[
            CommandHandler('start', start_command),
            MessageHandler(filters.Regex('^‚ùå –û—Ç–º–µ–Ω–∞$'), cancel_conversation)
        ],
        allow_reentry=True
    )
    
    # Add the conversation handler first
    app.add_handler(conv_handler)
    
    # Add callback handler for role fix
    app.add_handler(CallbackQueryHandler(handle_role_fix_callback, pattern='^fix_role_'))
    
    # Then add the general message handler for non-conversation buttons
    app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_simple_message))
    
    print("–õ–û–ì: –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω!")
    app.run_polling()

if __name__ == "__main__":
    main()

async def start_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start"""
    user = update.effective_user
    user_id = user.id
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –±–∞–∑—É
    users_db[user_id] = {
        'first_name': user.first_name,
        'username': user.username,
        'last_name': user.last_name,
        'last_start': datetime.now().strftime('%Y-%m-%d %H:%M:%S')
    }
    
    print(f"–ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {user.first_name} (ID: {user_id})")
    await show_main_menu(update, user_id)

async def show_main_menu(update, user_id):
    """–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –ø—Ä–∞–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    if user_id == HEADMAN_ID:
        keyboard = [
            ['üìÖ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ', 'üìù –î–ó'],
            ['‚ÑπÔ∏è –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è', 'üí° –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è'],
            ['üì¢ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –î–ó –≤—Å–µ–º', 'üì¢ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é']
        ]
        text = "–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, –°—Ç–∞—Ä–æ—Å—Ç–∞! üëë"
    elif user_id == DEPUTY_HEADMAN_ID:
        keyboard = [
            ['üìÖ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ', 'üìù –î–ó'],
            ['‚ÑπÔ∏è –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è', 'üí° –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è'],
            ['üì¢ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –î–ó –≤—Å–µ–º', 'üì¢ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é']
        ]
        text = "–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, –ó–∞–º –°—Ç–∞—Ä–æ—Å—Ç—ã! ‚≠ê"
    else:
        keyboard = [
            ['üìÖ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ', 'üìù –î–ó'],
            ['üìû –°–≤—è–∑–∞—Ç—å—Å—è —Å–æ –°—Ç–∞—Ä–æ—Å—Ç–æ–π', 'üìû –°–≤—è–∑–∞—Ç—å—Å—è —Å –ó–∞–º–æ–º'],
            ['üí° –ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å –∏–¥–µ—é']
        ]
        text = "–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å! –í—ã–±–µ—Ä–∏ –Ω—É–∂–Ω—ã–π —Ä–∞–∑–¥–µ–ª üëá"
    
    reply_markup = ReplyKeyboardMarkup(keyboard, resize_keyboard=True)
    
    if isinstance(update, Update):
        await update.message.reply_text(text, reply_markup=reply_markup)
    else:
        await update.edit_message_text(text, reply_markup=reply_markup)

async def handle_message(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π"""
    user_id = update.effective_user.id
    text = update.message.text
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–Ω–∞—á–∞–ª–∞ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è
    if (context.user_data.get('awaiting_homework') or 
        context.user_data.get('awaiting_information') or 
        context.user_data.get('awaiting_suggestion') or
        context.user_data.get('awaiting_homework_delete')):
        await handle_special_states(update, context)
        return
    
    # –ó–∞—Ç–µ–º –ø—Ä–æ–≤–µ—Ä—è–µ–º –æ–±—ã—á–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã
    if text == 'üìÖ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ':
        await show_schedule_periods(update, user_id)
    
    elif text == 'üìù –î–ó':
        await show_homework(update, user_id)
    
    elif text == '‚ÑπÔ∏è –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è' and user_id in [HEADMAN_ID, DEPUTY_HEADMAN_ID]:
        await show_information_admin(update, user_id)
    
    elif text == '‚ÑπÔ∏è –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è':
        await show_information_user(update, user_id)
    
    elif text == 'üí° –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è' and user_id in [HEADMAN_ID, DEPUTY_HEADMAN_ID]:
        await show_suggestions(update, user_id)
    
    elif text == 'üì¢ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –î–ó –≤—Å–µ–º' and user_id in [HEADMAN_ID, DEPUTY_HEADMAN_ID]:
        await ask_homework_details(update, context)
    
    elif text == 'üì¢ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é' and user_id in [HEADMAN_ID, DEPUTY_HEADMAN_ID]:
        await ask_information_details(update, context)
    
    elif text == '‚ùå –£–¥–∞–ª–∏—Ç—å –î–ó' and user_id in [HEADMAN_ID, DEPUTY_HEADMAN_ID]:
        await ask_homework_delete(update, context)
    
    elif text == 'üìû –°–≤—è–∑–∞—Ç—å—Å—è —Å–æ –°—Ç–∞—Ä–æ—Å—Ç–æ–π' and user_id not in [HEADMAN_ID, DEPUTY_HEADMAN_ID]:
        await contact_headman(update)
    
    elif text == 'üìû –°–≤—è–∑–∞—Ç—å—Å—è —Å –ó–∞–º–æ–º' and user_id not in [HEADMAN_ID, DEPUTY_HEADMAN_ID]:
        await contact_deputy(update)
    
    elif text == 'üí° –ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å –∏–¥–µ—é' and user_id not in [HEADMAN_ID, DEPUTY_HEADMAN_ID]:
        await suggest_idea(update, context)
    
    # –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–µ—Ä–∏–æ–¥–æ–≤ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è
    elif text in ['üìÖ –°–µ–≥–æ–¥–Ω—è', 'üìÖ –ó–∞–≤—Ç—Ä–∞', 'üìÖ –ù–µ–¥–µ–ª—è', 'üìÖ –í—Å–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ']:
        await handle_schedule_period(update, context)
    
    elif text == 'üîô –ù–∞–∑–∞–¥':
        await show_main_menu(update, user_id)
    
    else:
        await update.message.reply_text("–ò—Å–ø–æ–ª—å–∑—É–π –∫–Ω–æ–ø–∫–∏ –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ üëá")

async def ask_homework_details(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ó–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –¥–µ—Ç–∞–ª–∏ –î–ó –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏"""
    context.user_data['awaiting_homework'] = True
    await update.message.reply_text(
        "üìù <b>–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –î–ó</b>\n\n"
        "–ù–∞–ø–∏—à–∏ –≤ —Ñ–æ—Ä–º–∞—Ç–µ:\n"
        "<b>–ü—Ä–µ–¥–º–µ—Ç</b>\n"
        "<b>–ó–∞–¥–∞–Ω–∏–µ</b>\n"
        "<b>–°—Ä–æ–∫ —Å–¥–∞—á–∏</b>\n\n"
        "–ü—Ä–∏–º–µ—Ä:\n"
        "–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞\n"
        "–†–µ—à–∏—Ç—å –∑–∞–¥–∞—á–∏ 1-10 –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ 45\n"
        "–î–æ 15.09",
        parse_mode='HTML',
        reply_markup=ReplyKeyboardMarkup([['‚ùå –û—Ç–º–µ–Ω–∞']], resize_keyboard=True)
    )

async def ask_information_details(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ó–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤—Å–µ–º"""
    context.user_data['awaiting_information'] = True
    await update.message.reply_text(
        "‚ÑπÔ∏è <b>–û—Ç–ø—Ä–∞–≤–∫–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –≤—Å–µ–º</b>\n\n"
        "–ù–∞–ø–∏—à–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é, –∫–æ—Ç–æ—Ä—É—é –Ω—É–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –≤—Å–µ–º —É—á–µ–Ω–∏–∫–∞–º:",
        parse_mode='HTML',
        reply_markup=ReplyKeyboardMarkup([['‚ùå –û—Ç–º–µ–Ω–∞']], resize_keyboard=True)
    )

async def ask_homework_delete(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ó–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –Ω–æ–º–µ—Ä –î–ó –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è"""
    if not homeworks_db:
        await update.message.reply_text("üì≠ –ù–µ—Ç –¥–æ–º–∞—à–Ω–∏—Ö –∑–∞–¥–∞–Ω–∏–π –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è")
        return
    
    context.user_data['awaiting_homework_delete'] = True
    
    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ø–∏—Å–æ–∫ –î–ó —Å –Ω–æ–º–µ—Ä–∞–º–∏
    hw_list = "‚ùå <b>–£–¥–∞–ª–µ–Ω–∏–µ –î–ó</b>\n\n"
    for i, hw in enumerate(homeworks_db, 1):
        hw_list += f"{i}. {hw['subject']} - {hw['task'][:30]}...\n"
    
    hw_list += "\n–ù–∞–ø–∏—à–∏ –Ω–æ–º–µ—Ä –î–ó –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è (—Ç–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—É):"
    
    await update.message.reply_text(
        hw_list,
        parse_mode='HTML',
        reply_markup=ReplyKeyboardMarkup([['‚ùå –û—Ç–º–µ–Ω–∞']], resize_keyboard=True)
    )

async def handle_special_states(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è"""
    user_id = update.effective_user.id
    text = update.message.text
    
    if context.user_data.get('awaiting_homework'):
        if text == '‚ùå –û—Ç–º–µ–Ω–∞':
            context.user_data['awaiting_homework'] = False
            await show_main_menu(update, user_id)
            return
        
        lines = text.split('\n')
        if len(lines) >= 3:
            subject = lines[0].strip()
            task = lines[1].strip()
            deadline = lines[2].strip()
            
            homework = {
                'subject': subject,
                'task': task,
                'deadline': deadline,
                'date_added': datetime.now().strftime('%d.%m.%Y %H:%M'),
                'added_by': user_id
            }
            homeworks_db.append(homework)
            
            await send_homework_to_all(context.bot, homework)
            
            context.user_data['awaiting_homework'] = False
            keyboard = [
                ['üìù –î–ó', 'üì¢ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –î–ó –≤—Å–µ–º'],
                ['üîô –ù–∞–∑–∞–¥']
            ]
            reply_markup = ReplyKeyboardMarkup(keyboard, resize_keyboard=True)
            await update.message.reply_text(
                "‚úÖ –î–ó —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤—Å–µ–º —É—á–µ–Ω–∏–∫–∞–º!",
                reply_markup=reply_markup
            )
        else:
            await update.message.reply_text("‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç. –ù—É–∂–Ω–æ 3 —Å—Ç—Ä–æ–∫–∏: –ø—Ä–µ–¥–º–µ—Ç, –∑–∞–¥–∞–Ω–∏–µ, —Å—Ä–æ–∫")
    
    elif context.user_data.get('awaiting_information'):
        if text == '‚ùå –û—Ç–º–µ–Ω–∞':
            context.user_data['awaiting_information'] = False
            await show_main_menu(update, user_id)
            return
        
        info = {
            'text': text,
            'date_added': datetime.now().strftime('%d.%m.%Y %H:%M'),
            'added_by': user_id
        }
        info_db.append(info)
        
        await send_information_to_all(context.bot, info)
        
        context.user_data['awaiting_information'] = False
        keyboard = [
            ['‚ÑπÔ∏è –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è', 'üì¢ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é'],
            ['üîô –ù–∞–∑–∞–¥']
        ]
        reply_markup = ReplyKeyboardMarkup(keyboard, resize_keyboard=True)
        await update.message.reply_text(
            "‚úÖ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –≤—Å–µ–º —É—á–µ–Ω–∏–∫–∞–º!",
            reply_markup=reply_markup
        )
    
    elif context.user_data.get('awaiting_suggestion'):
        if text == '‚ùå –û—Ç–º–µ–Ω–∞':
            context.user_data['awaiting_suggestion'] = False
            await show_main_menu(update, user_id)
            return
        
        suggestion = {
            'user_id': user_id,
            'text': text,
            'date': datetime.now().strftime('%d.%m.%Y %H:%M')
        }
        suggestions_db.append(suggestion)
        
        user = update.effective_user
        sender_info = f"{user.first_name} (@{user.username})" if user.username else user.first_name
        
        try:
            await context.bot.send_message(
                HEADMAN_ID,
                f"üí° –ù–æ–≤–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –æ—Ç {sender_info}:\n\n{text}\n\nüìÖ {suggestion['date']}"
            )
            await context.bot.send_message(
                DEPUTY_HEADMAN_ID, 
                f"üí° –ù–æ–≤–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –æ—Ç {sender_info}:\n\n{text}\n\nüìÖ {suggestion['date']}"
            )
        except Exception as e:
            print(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è: {e}")
        
        context.user_data['awaiting_suggestion'] = False
        await update.message.reply_text(
            "‚úÖ –°–ø–∞—Å–∏–±–æ –∑–∞ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ! –ú—ã –µ–≥–æ —Ä–∞—Å—Å–º–æ—Ç—Ä–∏–º.",
            reply_markup=ReplyKeyboardMarkup([['üìÖ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ'], ['üí° –ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å –∏–¥–µ—é']], resize_keyboard=True)
        )
    
    elif context.user_data.get('awaiting_homework_delete'):
        if text == '‚ùå –û—Ç–º–µ–Ω–∞':
            context.user_data['awaiting_homework_delete'] = False
            await show_main_menu(update, user_id)
            return
        
        try:
            hw_number = int(text)
            if 1 <= hw_number <= len(homeworks_db):
                deleted_hw = homeworks_db.pop(hw_number - 1)
                context.user_data['awaiting_homework_delete'] = False
                
                keyboard = [
                    ['üìù –î–ó', '‚ùå –£–¥–∞–ª–∏—Ç—å –î–ó'],
                    ['üîô –ù–∞–∑–∞–¥']
                ]
                reply_markup = ReplyKeyboardMarkup(keyboard, resize_keyboard=True)
                
                await update.message.reply_text(
                    f"‚úÖ –î–ó ‚Ññ{hw_number} —É–¥–∞–ª–µ–Ω–æ!\n"
                    f"üìö {deleted_hw['subject']}\n"
                    f"üìã {deleted_hw['task'][:50]}...",
                    reply_markup=reply_markup
                )
            else:
                await update.message.reply_text("‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –Ω–æ–º–µ—Ä –î–ó. –ü–æ–ø—Ä–æ–±—É–π –µ—â–µ —Ä–∞–∑:")
        except ValueError:
            await update.message.reply_text("‚ùå –í–≤–µ–¥–∏ —Ç–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—É (–Ω–æ–º–µ—Ä –î–ó):")

async def send_homework_to_all(bot, homework):
    """–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –î–ó –≤—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º"""
    homework_text = (
        f"üìù <b>–ù–û–í–û–ï –î–û–ú–ê–®–ù–ï–ï –ó–ê–î–ê–ù–ò–ï</b>\n\n"
        f"üìö <b>–ü—Ä–µ–¥–º–µ—Ç:</b> {homework['subject']}\n"
        f"üìã <b>–ó–∞–¥–∞–Ω–∏–µ:</b> {homework['task']}\n"
        f"‚è∞ <b>–°—Ä–æ–∫ —Å–¥–∞—á–∏:</b> {homework['deadline']}\n"
        f"üìÖ <b>–î–æ–±–∞–≤–ª–µ–Ω–æ:</b> {homework['date_added']}\n\n"
        f"üí° –ò—Å–ø–æ–ª—å–∑—É–π –∫–Ω–æ–ø–∫—É 'üìù –î–ó' –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –≤—Å–µ—Ö –∑–∞–¥–∞–Ω–∏–π"
    )
    
    sent_count = 0
    for user_id in users_db:
        try:
            await bot.send_message(user_id, homework_text, parse_mode='HTML')
            sent_count += 1
        except Exception as e:
            print(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –î–ó –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {user_id}: {e}")
    
    print(f"–î–ó –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ {sent_count} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º")

async def send_information_to_all(bot, information):
    """–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –≤—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º"""
    info_text = (
        f"üì¢ <b>–í–ê–ñ–ù–ê–Ø –ò–ù–§–û–†–ú–ê–¶–ò–Ø</b>\n\n"
        f"{information['text']}\n\n"
        f"üìÖ <b>–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ:</b> {information['date_added']}"
    )
    
    sent_count = 0
    for user_id in users_db:
        try:
            await bot.send_message(user_id, info_text, parse_mode='HTML')
            sent_count += 1
        except Exception as e:
            print(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {user_id}: {e}")
    
    print(f"–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ {sent_count} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º")

async def show_homework(update: Update, user_id: int):
    """–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≤—Å–µ –î–ó —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é —É–¥–∞–ª–µ–Ω–∏—è –¥–ª—è –∞–¥–º–∏–Ω–æ–≤"""
    if not homeworks_db:
        await update.message.reply_text("üì≠ –ü–æ–∫–∞ –Ω–µ—Ç –¥–æ–º–∞—à–Ω–∏—Ö –∑–∞–¥–∞–Ω–∏–π")
        return
    
    hw_text = "üìù <b>–í–°–ï –î–û–ú–ê–®–ù–ò–ï –ó–ê–î–ê–ù–ò–Ø</b>\n\n"
    
    for i, hw in enumerate(homeworks_db, 1):
        hw_text += (
            f"üîπ <b>–ó–∞–¥–∞–Ω–∏–µ {i}</b>\n"
            f"üìö <b>–ü—Ä–µ–¥–º–µ—Ç:</b> {hw['subject']}\n"
            f"üìã <b>–ó–∞–¥–∞–Ω–∏–µ:</b> {hw['task']}\n"
            f"‚è∞ <b>–°—Ä–æ–∫:</b> {hw['deadline']}\n"
            f"üìÖ <b>–î–æ–±–∞–≤–ª–µ–Ω–æ:</b> {hw['date_added']}\n\n"
        )
    
    hw_text += f"üìä <b>–í—Å–µ–≥–æ –∑–∞–¥–∞–Ω–∏–π:</b> {len(homeworks_db)}"
    
    # –†–∞–∑–Ω—ã–µ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã –¥–ª—è –∞–¥–º–∏–Ω–æ–≤ –∏ –æ–±—ã—á–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    if user_id in [HEADMAN_ID, DEPUTY_HEADMAN_ID]:
        keyboard = [
            ['‚ùå –£–¥–∞–ª–∏—Ç—å –î–ó', 'üì¢ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –î–ó –≤—Å–µ–º'],
            ['üîô –ù–∞–∑–∞–¥']
        ]
    else:
        keyboard = [['üîô –ù–∞–∑–∞–¥']]
    
    reply_markup = ReplyKeyboardMarkup(keyboard, resize_keyboard=True)
    await update.message.reply_text(hw_text, parse_mode='HTML', reply_markup=reply_markup)

async def show_information_admin(update: Update, user_id: int):
    """–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏–∏"""
    info_text = (
        "‚ÑπÔ∏è <b>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –¥–ª—è —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–∞</b>\n\n"
        f"üëë <b>–°—Ç–∞—Ä–æ—Å—Ç–∞</b>: {HEADMAN_USERNAME}\n"
        f"‚≠ê <b>–ó–∞–º —Å—Ç–∞—Ä–æ—Å—Ç—ã</b>: {DEPUTY_HEADMAN_USERNAME}\n\n"
        f"üë• <b>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ –±–æ—Ç–µ:</b> {len(users_db)}"
    )
    
    keyboard = [
        ['üì¢ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é', 'üîô –ù–∞–∑–∞–¥']
    ]
    reply_markup = ReplyKeyboardMarkup(keyboard, resize_keyboard=True)
    await update.message.reply_text(info_text, parse_mode='HTML', reply_markup=reply_markup)

async def show_information_user(update: Update, user_id: int):
    """–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –¥–ª—è –æ–±—ã—á–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π"""
    if not info_db:
        await update.message.reply_text("üì≠ –ü–æ–∫–∞ –Ω–µ—Ç –≤–∞–∂–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏")
        return
    
    recent_info = info_db[-3:] if len(info_db) > 3 else info_db
    
    info_text = "‚ÑπÔ∏è <b>–í–ê–ñ–ù–ê–Ø –ò–ù–§–û–†–ú–ê–¶–ò–Ø</b>\n\n"
    
    for i, info in enumerate(recent_info, 1):
        info_text += (
            f"üîπ <b>–°–æ–æ–±—â–µ–Ω–∏–µ {i}</b>\n"
            f"{info['text']}\n"
            f"üìÖ {info['date_added']}\n\n"
        )
    
    keyboard = [['üîô –ù–∞–∑–∞–¥']]
    reply_markup = ReplyKeyboardMarkup(keyboard, resize_keyboard=True)
    await update.message.reply_text(info_text, parse_mode='HTML', reply_markup=reply_markup)

async def show_suggestions(update: Update, user_id: int):
    """–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –æ—Ç —É—á–µ–Ω–∏–∫–æ–≤"""
    if not suggestions_db:
        await update.message.reply_text("üì≠ –ü–æ–∫–∞ –Ω–µ—Ç –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π –æ—Ç —É—á–µ–Ω–∏–∫–æ–≤")
        return
    
    suggestions_text = "üí° <b>–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –æ—Ç —É—á–µ–Ω–∏–∫–æ–≤</b>\n\n"
    for i, suggestion in enumerate(suggestions_db, 1):
        user_info = users_db.get(suggestion['user_id'], {})
        username = user_info.get('first_name', '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π')
        suggestions_text += f"{i}. {suggestion['text']}\nüë§ {username} | üìÖ {suggestion['date']}\n\n"
    
    keyboard = [['üîô –ù–∞–∑–∞–¥']]
    reply_markup = ReplyKeyboardMarkup(keyboard, resize_keyboard=True)
    await update.message.reply_text(suggestions_text, parse_mode='HTML', reply_markup=reply_markup)

async def contact_headman(update: Update):
    """–°–≤—è–∑—å —Å–æ —Å—Ç–∞—Ä–æ—Å—Ç–æ–π"""
    contact_text = (
        "üëë <b>–°–≤—è–∑—å —Å–æ –°—Ç–∞—Ä–æ—Å—Ç–æ–π</b>\n\n"
        f"üìû Telegram: {HEADMAN_USERNAME}\n"
    )
    await update.message.reply_text(contact_text, parse_mode='HTML')

async def contact_deputy(update: Update):
    """–°–≤—è–∑—å —Å –∑–∞–º —Å—Ç–∞—Ä–æ—Å—Ç—ã"""
    contact_text = (
        "‚≠ê <b>–°–≤—è–∑—å —Å –ó–∞–º–æ–º –°—Ç–∞—Ä–æ—Å—Ç—ã</b>\n\n"
        f"üìû Telegram: {DEPUTY_HEADMAN_USERNAME}\n"
    )
    await update.message.reply_text(contact_text, parse_mode='HTML')

async def suggest_idea(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å –∏–¥–µ—é –ø–æ —Ä–∞–∑–≤–∏—Ç–∏—é –±–æ—Ç–∞"""
    context.user_data['awaiting_suggestion'] = True
    await update.message.reply_text(
        "üí° –ù–∞–ø–∏—à–∏ —Å–≤–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –ø–æ —É–ª—É—á—à–µ–Ω–∏—é –±–æ—Ç–∞:\n\n"
        "–ß—Ç–æ –±—ã —Ç—ã —Ö–æ—Ç–µ–ª –¥–æ–±–∞–≤–∏—Ç—å –∏–ª–∏ –∏–∑–º–µ–Ω–∏—Ç—å?",
        reply_markup=ReplyKeyboardMarkup([['‚ùå –û—Ç–º–µ–Ω–∞']], resize_keyboard=True)
    )

async def show_schedule_periods(update: Update, user_id: int):
    """–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≤—ã–±–æ—Ä –ø–µ—Ä–∏–æ–¥–∞ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è"""
    keyboard = [
        ['üìÖ –°–µ–≥–æ–¥–Ω—è', 'üìÖ –ó–∞–≤—Ç—Ä–∞'],
        ['üìÖ –ù–µ–¥–µ–ª—è', 'üìÖ –í—Å–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ'],
        ['üîô –ù–∞–∑–∞–¥']
    ]
    reply_markup = ReplyKeyboardMarkup(keyboard, resize_keyboard=True)
    await update.message.reply_text("–í—ã–±–µ—Ä–∏ –ø–µ—Ä–∏–æ–¥ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è:", reply_markup=reply_markup)

async def handle_schedule_period(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤—ã–±–æ—Ä –ø–µ—Ä–∏–æ–¥–∞ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è"""
    text = update.message.text
    user_id = update.effective_user.id
    
    if text in ['üìÖ –°–µ–≥–æ–¥–Ω—è', 'üìÖ –ó–∞–≤—Ç—Ä–∞', 'üìÖ –ù–µ–¥–µ–ª—è', 'üìÖ –í—Å–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ']:
        schedule = get_schedule(text)
        await update.message.reply_text(schedule, parse_mode='HTML')
    elif text == 'üîô –ù–∞–∑–∞–¥':
        await show_main_menu(update, user_id)
    else:
        await update.message.reply_text("–í—ã–±–µ—Ä–∏ –ø–µ—Ä–∏–æ–¥ –∏–∑ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–Ω—ã—Ö üëá")

def get_schedule(period):
    """–ü–æ–ª—É—á–∞–µ—Ç –∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –ø–µ—Ä–∏–æ–¥–∞"""
    try:
        schedule_data = fetch_schedule_data()
        if not schedule_data:
            return "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ"

        group = "–ò–î-127"
        if group not in schedule_data:
            return f"‚ùå –ù–µ—Ç —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è –¥–ª—è –≥—Ä—É–ø–ø—ã {group}"

        lessons = schedule_data[group]
        
        # –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
        now_yekat = datetime.now(YEKATERINBURG_TZ)
        print(f"–¢–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è –ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥: {now_yekat}")
        print(f"–¢–µ–∫—É—â–∞—è –¥–∞—Ç–∞ –ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥: {now_yekat.date()}")
        print(f"–í—Å–µ–≥–æ –∑–∞–Ω—è—Ç–∏–π –≤ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–∏: {len(lessons)}")
        
        if period == 'üìÖ –°–µ–≥–æ–¥–Ω—è':
            filtered_lessons = filter_today_lessons(lessons)
            title = "üìÖ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è"
            print(f"–°–µ–≥–æ–¥–Ω—è—à–Ω–∏—Ö –∑–∞–Ω—è—Ç–∏–π: {len(filtered_lessons)}")
        elif period == 'üìÖ –ó–∞–≤—Ç—Ä–∞':
            filtered_lessons = filter_tomorrow_lessons(lessons)
            title = "üìÖ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –Ω–∞ –∑–∞–≤—Ç—Ä–∞"
            print(f"–ó–∞–≤—Ç—Ä–∞—à–Ω–∏—Ö –∑–∞–Ω—è—Ç–∏–π: {len(filtered_lessons)}")
        elif period == 'üìÖ –ù–µ–¥–µ–ª—è':
            filtered_lessons = filter_week_lessons(lessons)
            title = "üìÖ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –Ω–∞ –Ω–µ–¥–µ–ª—é"
        else:
            filtered_lessons = lessons
            title = "üìÖ –í—Å–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ"

        if not filtered_lessons:
            return f"‚ùå –ù–µ—Ç –∑–∞–Ω—è—Ç–∏–π –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –ø–µ—Ä–∏–æ–¥–∞: {period}"

        return format_schedule(filtered_lessons, title)

    except Exception as e:
        return f"‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞: {str(e)}"

def fetch_schedule_data():
    """–ü–æ–ª—É—á–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è —Å —Å–∞–π—Ç–∞"""
    try:
        url = "https://pmk-online.ru/students/schedule/"
        
        resp = requests.get(url, timeout=10)
        resp.raise_for_status()
        html = resp.text

        match = re.search(r"const scheduleData\s*=\s*(\{.*?\});", html, re.S)
        if not match:
            return None

        schedule_raw = match.group(1)
        schedule_json_str = schedule_raw.replace(";", "")
        return json.loads(schedule_json_str)
    
    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è: {e}")
        return None

def filter_today_lessons(lessons):
    """–§–∏–ª—å—Ç—Ä—É–µ—Ç –∑–∞–Ω—è—Ç–∏—è –Ω–∞ —Å–µ–≥–æ–¥–Ω—è —Å —É—á–µ—Ç–æ–º –≤—Ä–µ–º–µ–Ω–∏ –ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥–∞"""
    today_yekat = datetime.now(YEKATERINBURG_TZ).date()
    print(f"–ò—â–µ–º –∑–∞–Ω—è—Ç–∏—è –Ω–∞ —Å–µ–≥–æ–¥–Ω—è (–ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥): {today_yekat}")
    
    result = []
    for lesson in lessons:
        try:
            lesson_date_str = lesson.get('date', '')
            if not lesson_date_str:
                continue
                
            # –ü–∞—Ä—Å–∏–º –¥–∞—Ç—É –∏–∑ UTC –∏ –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ –ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥
            lesson_date_utc = datetime.fromisoformat(lesson_date_str.replace('Z', '+00:00'))
            lesson_date_yekat = lesson_date_utc.astimezone(YEKATERINBURG_TZ).date()
            
            if lesson_date_yekat == today_yekat:
                result.append(lesson)
                print(f"–ù–∞–π–¥–µ–Ω–æ –∑–∞–Ω—è—Ç–∏–µ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è: {lesson_date_str} -> {lesson_date_yekat} - {lesson.get('subjectFull')}")
        except Exception as e:
            print(f"–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–Ω—è—Ç–∏—è: {e}")
            continue
    
    return result

def filter_tomorrow_lessons(lessons):
    """–§–∏–ª—å—Ç—Ä—É–µ—Ç –∑–∞–Ω—è—Ç–∏—è –Ω–∞ –∑–∞–≤—Ç—Ä–∞ —Å —É—á–µ—Ç–æ–º –≤—Ä–µ–º–µ–Ω–∏ –ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥–∞"""
    tomorrow_yekat = (datetime.now(YEKATERINBURG_TZ) + timedelta(days=1)).date()
    print(f"–ò—â–µ–º –∑–∞–Ω—è—Ç–∏—è –Ω–∞ –∑–∞–≤—Ç—Ä–∞ (–ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥): {tomorrow_yekat}")
    
    result = []
    for lesson in lessons:
        try:
            lesson_date_str = lesson.get('date', '')
            if not lesson_date_str:
                continue
                
            # –ü–∞—Ä—Å–∏–º –¥–∞—Ç—É –∏–∑ UTC –∏ –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ –ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥
            lesson_date_utc = datetime.fromisoformat(lesson_date_str.replace('Z', '+00:00'))
            lesson_date_yekat = lesson_date_utc.astimezone(YEKATERINBURG_TZ).date()
            
            if lesson_date_yekat == tomorrow_yekat:
                result.append(lesson)
                print(f"–ù–∞–π–¥–µ–Ω–æ –∑–∞–Ω—è—Ç–∏–µ –Ω–∞ –∑–∞–≤—Ç—Ä–∞: {lesson_date_str} -> {lesson_date_yekat} - {lesson.get('subjectFull')}")
        except Exception as e:
            print(f"–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–Ω—è—Ç–∏—è: {e}")
            continue
    
    return result

def filter_week_lessons(lessons):
    """–§–∏–ª—å—Ç—Ä—É–µ—Ç –∑–∞–Ω—è—Ç–∏—è –Ω–∞ –Ω–µ–¥–µ–ª—é —Å —É—á–µ—Ç–æ–º –≤—Ä–µ–º–µ–Ω–∏ –ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥–∞"""
    today_yekat = datetime.now(YEKATERINBURG_TZ)
    week_end = today_yekat + timedelta(days=7)
    
    week_lessons = []
    for lesson in lessons:
        try:
            lesson_date_str = lesson.get('date', '')
            if not lesson_date_str:
                continue
                
            lesson_date_utc = datetime.fromisoformat(lesson_date_str.replace('Z', '+00:00'))
            lesson_date_yekat = lesson_date_utc.astimezone(YEKATERINBURG_TZ)
            
            if today_yekat.date() <= lesson_date_yekat.date() <= week_end.date():
                week_lessons.append(lesson)
        except Exception as e:
            print(f"–û—à–∏–±–∫–∞ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –∑–∞–Ω—è—Ç–∏—è: {e}")
            continue
    
    return week_lessons

def get_lesson_time(lesson_number):
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≤—Ä–µ–º—è –ø–∞—Ä—ã –ø–æ –Ω–æ–º–µ—Ä—É —Å–æ–≥–ª–∞—Å–Ω–æ –≤–∞—à–µ–º—É —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é"""
    lesson_times = {
        1: ("08:30", "10:05"),
        2: ("10:15", "11:50"), 
        3: ("12:40", "14:15"),
        4: ("14:25", "16:00"),
        5: ("16:10", "17:45"),
        6: ("17:55", "19:30"),
    }
    return lesson_times.get(lesson_number, ("‚ùì", "‚ùì"))

def format_schedule(lessons, title):
    if not lessons:
        return "‚ùå –ù–µ—Ç –∑–∞–Ω—è—Ç–∏–π"
    
    # –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –¥–∞—Ç–µ –∏ –Ω–æ–º–µ—Ä—É –ø–∞—Ä—ã
    lessons.sort(key=lambda x: (x['date'], x.get('lessonNumber', 0)))
    
    result = [f"<b>{title}</b>\n", "<b>–ì—Ä—É–ø–ø–∞: –ò–î-127</b>\n"]
    
    current_date = None
    for lesson in lessons:
        try:
            # –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º UTC –≤—Ä–µ–º—è –≤ –µ–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥—Å–∫–æ–µ
            lesson_date_utc = datetime.fromisoformat(lesson['date'].replace('Z', '+00:00'))
            lesson_date_yekat = lesson_date_utc.astimezone(YEKATERINBURG_TZ)
            
            date_str = lesson_date_yekat.strftime('%d.%m.%Y')
            
            if date_str != current_date:
                current_date = date_str
                # –î–æ–±–∞–≤–ª—è–µ–º –¥–µ–Ω—å –Ω–µ–¥–µ–ª–∏
                day_names = ['–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫', '–í—Ç–æ—Ä–Ω–∏–∫', '–°—Ä–µ–¥–∞', '–ß–µ—Ç–≤–µ—Ä–≥', '–ü—è—Ç–Ω–∏—Ü–∞', '–°—É–±–±–æ—Ç–∞', '–í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ']
                day_of_week = day_names[lesson_date_yekat.weekday()]
                result.append(f"\nüìÖ <b>{date_str} ({day_of_week})</b>")
            
            # –ü–æ–ª—É—á–∞–µ–º –≤—Ä–µ–º—è –ø–∞—Ä—ã –ø–æ –Ω–æ–º–µ—Ä—É
            lesson_number = lesson.get('lessonNumber', 0)
            start_time, end_time = get_lesson_time(lesson_number)
            
            lesson_text = (
                f"    ‚è∞ {start_time}-{end_time} | {lesson_number} –ø–∞—Ä–∞\n"
                f"    üìö {lesson['subjectFull']}\n"
                f"    üë®‚Äçüè´ {lesson.get('teacher', '–ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å –Ω–µ —É–∫–∞–∑–∞–Ω')}\n"
                f"    üö™ {lesson['room']}\n"
            )
            result.append(lesson_text)
            
        except Exception as e:
            print(f"–û—à–∏–±–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞–Ω—è—Ç–∏—è: {e}")
            continue
    
    result.append(f"\nüìä <b>–í—Å–µ–≥–æ –∑–∞–Ω—è—Ç–∏–π:</b> {len(lessons)}")
    return "\n".join(result)

async def send_daily_schedule(bot):
    """–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –Ω–∞ –∑–∞–≤—Ç—Ä–∞ –≤—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º –≤ 19:00 –ø–æ –ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥—É"""
    global background_task_running
    
    while background_task_running:
        try:
            now = datetime.now(YEKATERINBURG_TZ)
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å–µ–π—á–∞—Å 19:00 –ø–æ –ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥—É?
            if now.hour == 19 and now.minute == 0:
                print(f"‚è∞ –í—Ä–µ–º—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è! {now}")
                
                # –ü–æ–ª—É—á–∞–µ–º —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –Ω–∞ –∑–∞–≤—Ç—Ä–∞
                schedule_data = fetch_schedule_data()
                if schedule_data and "–ò–î-127" in schedule_data:
                    lessons = schedule_data["–ò–î-127"]
                    tomorrow_lessons = filter_tomorrow_lessons(lessons)
                    
                    if tomorrow_lessons:
                        schedule_text = format_schedule(tomorrow_lessons, "üìÖ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –Ω–∞ –∑–∞–≤—Ç—Ä–∞")
                        
                        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º
                        sent_count = 0
                        for user_id in users_db:
                            try:
                                await bot.send_message(user_id, schedule_text, parse_mode='HTML')
                                sent_count += 1
                            except Exception as e:
                                print(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {user_id}: {e}")
                        
                        print(f"‚úÖ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –Ω–∞ –∑–∞–≤—Ç—Ä–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ {sent_count} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º –≤ {now}")
                    else:
                        print("‚ÑπÔ∏è –ù–∞ –∑–∞–≤—Ç—Ä–∞ –Ω–µ—Ç –∑–∞–Ω—è—Ç–∏–π")
                else:
                    print("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ")
                
                # –ñ–¥–µ–º 1 –º–∏–Ω—É—Ç—É —á—Ç–æ–±—ã –Ω–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑ –≤ —Ç–µ—á–µ–Ω–∏–µ –æ–¥–Ω–æ–π –º–∏–Ω—É—Ç—ã
                await asyncio.sleep(60)
            else:
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É
                await asyncio.sleep(60)
                
        except Exception as e:
            print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –µ–∂–µ–¥–Ω–µ–≤–Ω–æ–≥–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è: {e}")
            await asyncio.sleep(60)

async def error_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    print(f"–û—à–∏–±–∫–∞: {context.error}")

async def main():
    """–û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞"""
    print("–ó–∞–ø—É—Å–∫ –±–æ—Ç–∞ —Å –ø–æ–ª–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å—é...")
    
    # –°–æ–∑–¥–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
    app = Application.builder().token(BOT_TOKEN).build()
    
    # –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
    app.add_handler(CommandHandler("start", start_command))
    app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_message))
    
    # –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫
    app.add_error_handler(error_handler)
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞
    print("–ë–æ—Ç –∑–∞–ø—É—â–µ–Ω!")
    print("–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å—Å—è –µ–∂–µ–¥–Ω–µ–≤–Ω–æ –≤ 19:00 –ø–æ –ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥—É")
    print("–î–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –Ω–∞–∂–º–∏—Ç–µ Ctrl+C")
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º —Ñ–æ–Ω–æ–≤—É—é –∑–∞–¥–∞—á—É –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è
    background_task = asyncio.create_task(send_daily_schedule(app.bot))
    
    try:
        # –ó–∞–ø—É—Å–∫–∞–µ–º polling
        await app.initialize()
        await app.start()
        await app.updater.start_polling()
        
        # –ñ–¥–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
        await background_task
        
    except asyncio.CancelledError:
        print("–ë–æ—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω")
    except Exception as e:
        print(f"–û—à–∏–±–∫–∞: {e}")
    finally:
        global background_task_running
        background_task_running = False
        await app.stop()
        await app.shutdown()

if __name__ == "__main__":
    # –ó–∞–ø—É—Å–∫–∞–µ–º –æ—Å–Ω–æ–≤–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é
    asyncio.run(main())
