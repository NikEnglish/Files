import cv2
import numpy as np

# Настройки камеры и размера экрана
CAMERA_IP = "http://192.168.31.40:4747/video"
PROJECTION_WIDTH = 1920
PROJECTION_HEIGHT = 1200

# Инициализация видеопотока камеры
cap = cv2.VideoCapture(CAMERA_IP)

if not cap.isOpened():
    print("Не удалось подключиться к камере.")
    exit()

# Функция для поиска углов (контуров) на изображении
def find_corners(frame):
    """
    Ищем границы поля (по контурной линии) и определяем углы поля.
    """
    # Преобразуем в черно-белое изображение для упрощения обработки
    gray = cv2.cvtColor(frame, cv2.COLOR_BGR2GRAY)
    
    # Применяем детектор краёв Canny
    edges = cv2.Canny(gray, 50, 150, apertureSize=3)

    # Находим контуры на изображении
    contours, _ = cv2.findContours(edges, cv2.RETR_EXTERNAL, cv2.CHAIN_APPROX_SIMPLE)

    # Для отладки можем рисовать контуры
    frame_copy = frame.copy()
    cv2.drawContours(frame_copy, contours, -1, (0, 255, 0), 3)

    # Теперь находим углы этого контура
    if len(contours) > 0:
        # Предполагаем, что первый контур это поле, и находим его углы
        epsilon = 0.02 * cv2.arcLength(contours[0], True)
        approx = cv2.approxPolyDP(contours[0], epsilon, True)
        
        # Если мы нашли больше 4-х точек, значит это не прямоугольник
        if len(approx) == 4:
            corners = approx  # Найденные углы
        else:
            corners = []
    else:
        corners = []
    
    return corners, frame_copy

def draw_corners(frame, corners):
    """
    Отображаем найденные углы на изображении.
    """
    for corner in corners:
        cv2.circle(frame, tuple(corner[0]), 10, (0, 0, 255), -1)  # Красные точки на углах

def calibrate():
    """
    Логика калибровки.
    """
    while True:
        ret, frame = cap.read()
        if not ret:
            break
        
        frame = cv2.resize(frame, (PROJECTION_WIDTH, PROJECTION_HEIGHT))

        # Поиск контуров и углов
        corners, debug_frame = find_corners(frame)

        # Для отладки рисуем контуры и углы на экране
        draw_corners(debug_frame, corners)

        # Выводим изображение для отладки
        cv2.imshow("Проектор - Калибровка", debug_frame)

        key = cv2.waitKey(1) & 0xFF
        if key == ord('q'):  # Нажать q для выхода
            break
        if key == ord('r'):  # Нажать r для повторной калибровки
            print("Перезапуск калибровки.")
            continue

    cap.release()
    cv2.destroyAllWindows()

if __name__ == "__main__":
    calibrate()
